"use strict";!function(window){function isOSSClient(){var sync=navigator.userAgent.split(";")[0]||"";return"oss"==sync.toLowerCase()}function getCanonicalizedOssHeaders(headers){var tmp_headers={},canonicalized_oss_headers="";for(var k in headers)0===k.toLowerCase().indexOf("x-oss-",0)&&(tmp_headers[k.toLowerCase()]=headers[k]);if(tmp_headers!={}){var x_header_list=[];for(var k in tmp_headers)x_header_list.push(k);x_header_list.sort();for(var k in x_header_list)canonicalized_oss_headers+=x_header_list[k]+":"+tmp_headers[x_header_list[k]]+"\n"}return canonicalized_oss_headers}var accessId="fmVEoAkpUByBS1cs",accessSecret="HWsJ79uEwsrh7PB6ASGpyrdZkwJWdR",OSSClient={getAccessID:function(){return JSON.stringify(accessId)},getSignature:function(param){var parseParam=JSON.parse(param),arr=[parseParam.verb,parseParam.content_md5,parseParam.content_type,parseParam.expires],canonicalizedOSSheaders="";parseParam.canonicalized_oss_headers&&(canonicalizedOSSheaders=getCanonicalizedOssHeaders(parseParam.canonicalized_oss_headers));var canonicalizedResource=parseParam.canonicalized_resource;return JSON.stringify(CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA1(arr.join("\n")+"\n"+canonicalizedOSSheaders+canonicalizedResource,accessSecret)))},changeHost:function(region){region=JSON.parse(region);var host=[region,region?".":"","aliyuncs.com"].join("");return JSON.stringify(host)},changeUpload:function(){},changeDownload:function(){},getUpload:function(){return JSON.stringify({download:0,upload:0,count:1,list:[{bucket:"121212121212",object:"PhpStorm-8.0.dmg",fullpath:"C:\\Users\\george\\Desktop\\PhpStorm-8.0.dmg",offset:1e8,filesize:137181104,status:5,speed:1e4,errormsg:""},{bucket:"121212121212",object:"PhpStorm-8.0.dmg",fullpath:"C:\\Users\\george\\Desktop\\PhpStorm-8.0.dmg",offset:0,filesize:137181104,status:5,speed:0,errormsg:""}]})},getDownload:function(){},configInfo:function(){JSON.stringify({source:"",disable_location_select:0,host:"aliyuncs.com",locations:[{location:"oss-cn-guizhou-a",name:"互联网",enable:0},{location:"oss-cn-gzzwy-a",name:"政务外网",enable:0},{location:"oss-cn-hangzhou-a",name:"杭州",enable:1},{location:"oss-cn-qingdao-a",name:"青岛",enable:1},{location:"oss-cn-beijing-a",name:"北京",enable:1},{location:"oss-cn-hongkong-a",name:"香港",enable:1},{location:"oss-cn-shenzhen-a",name:"深圳",enable:1}]});return JSON.stringify({source:"guizhou",disable_location_select:1,host:"aliyuncs.com",locations:[{location:"oss-cn-guizhou-a",name:"互联网",enable:1},{location:"oss-cn-gzzwy-a",name:"政务外网",enable:1},{location:"oss-cn-hangzhou-a",name:"杭州",enable:0},{location:"oss-cn-qingdao-a",name:"青岛",enable:0},{location:"oss-cn-beijing-a",name:"北京",enable:0},{location:"oss-cn-hongkong-a",name:"香港",enable:0},{location:"oss-cn-shenzhen-a",name:"深圳",enable:0}]})},getCurrentLocation:function(){return JSON.stringify("oss-cn-guizhou-a")}};isOSSClient()||(window.OSSClient=OSSClient)}(window),window.debug=!1;var debugInterfaces=[],OSS={invoke:function(name,param,callback,log){var _self=this;if("undefined"==typeof OSSClient)throw new Error("Can not find OSSClient");if("function"!=typeof OSSClient[name]&&debugInterfaces.indexOf(name)<0)throw new Error("Can not find interface "+name);var args=[];param&&args.push(JSON.stringify(param)),"function"==typeof callback&&args.push(function(re){log!==!1&&_self.log(name+":callback",re),re=re?"object"==typeof re?re:JSON.parse(re):"",callback(re)});var re="";return log!==!1&&this.log(name,args),args.length?1==args.length?re=OSSClient[name](args[0]):2==args.length&&(re=OSSClient[name](args[0],args[1])):re=debugInterfaces.indexOf(name)>=0?this[name]():OSSClient[name](),log!==!1&&this.log(name+":return",re),re=re?JSON.parse(re):""},log:function(name,info){window.debug&&console.log("%c"+name,"color:blue",info)},getUserAgent:function(){return navigator.userAgent.split(";")},getClientOS:function(){var os=this.getUserAgent()[2]||"";return os.toLowerCase()},isWindowsClient:function(){return"windows"==this.getClientOS()},isMacClient:function(){return"mac"==this.getClientOS()},isClientOS:function(){return this.isWindowsClient()||this.isMacClient()},isOSSClient:function(){var sync=this.getUserAgent()[0]||"";return"gk_sync"==sync.toLowerCase()}};angular.module("OSSCommon",["ui.select"]).config(["uiSelectConfig",function(uiSelectConfig){uiSelectConfig.theme="bootstrap"}]).factory("OSSDialog",[function(){var defaultParam={type:"normal",resize:0,width:490,height:420};return{exportAuthorization:function(){var UIPath=OSS.invoke("getUIPath");OSS.invoke("showWnd",angular.extend({},defaultParam,{url:UIPath+"/export-authorization.html"}))},customServerHost:function(){var UIPath=OSS.invoke("getUIPath");OSS.invoke("showWnd",angular.extend({},defaultParam,{url:UIPath+"/custom-domain.html"}))},setting:function(){var UIPath=OSS.invoke("getUIPath");OSS.invoke("showWnd",angular.extend({},defaultParam,{url:UIPath+"/setting.html"}))}}}]).factory("OSSConfig",[function(){var config=OSS.invoke("configInfo");return config||(config={source:"",disable_location_select:0,host:"aliyuncs.com",locations:[{location:"oss-cn-guizhou-a",name:"互联网",enable:0},{location:"oss-cn-gzzwy-a-internal",name:"政务外网",enable:0},{location:"oss-cn-hangzhou",name:"杭州",enable:1},{location:"oss-cn-qingdao",name:"青岛",enable:1},{location:"oss-cn-beijing",name:"北京",enable:1},{location:"oss-cn-hongkong",name:"香港",enable:1},{location:"oss-cn-shenzhen",name:"深圳",enable:1}]}),{isCustomClient:function(){return""!=config.source},isGuiZhouClient:function(){return"guizhou"==config.source},showRefer:function(){return!!config.showrefer},isDisableLocationSelect:function(){return 1==config.disable_location_select},getLocations:function(){return config.locations||[]},getHost:function(){return config.host}}}]).factory("OSSRegion",["OSSConfig",function(OSSConfig){var locations=OSSConfig.getLocations(),currentLocation=OSS.invoke("getCurrentLocation");return{list:function(){return _.where(locations,{enable:1})},getRegionByLocation:function(location){return _.find(locations,function(item){return 0===location.indexOf(item.location.replace("-internal",""))})},changeLocation:function(location){return location.indexOf("-internal")>0?location:currentLocation&&location+"-internal"==currentLocation?location+"-internal":location}}}]).factory("OSSException",["OSSConfig",function(OSSConfig){var erroList={AccessDenied:"拒绝访问",BucketAlreadyExists:"Bucket已经存在",BucketNotEmpty:"Bucket不为空",EntityTooLarge:"实体过大",EntityTooSmall:"实体过小",FileGroupTooLarge:"文件组过大",FilePartNotExist:"文件Part不存在",FilePartStale:"文件Part过时",InvalidArgument:"参数格式错误",InvalidAccessKeyId:"Access Key ID不存在",InvalidBucketName:"无效的Bucket名字",InvalidDigest:"无效的摘要",InvalidObjectName:"无效的Object名字",InvalidPart:"无效的Part",InvalidPartOrder:"无效的part顺序",InvalidTargetBucketForLogging:"Logging操作中有无效的目标bucket",InternalError:"OSS内部发生错误",MalformedXML:"XML格式非法",MethodNotAllowed:"不支持的方法",MissingArgument:"缺少参数",MissingContentLength:"缺少内容长度",NoSuchBucket:"Bucket不存在",NoSuchKey:"文件不存在",NoSuchUpload:"Multipart Upload ID不存在",NotImplemented:"无法处理的方法",PreconditionFailed:"预处理错误",RequestTimeTooSkewed:"发起请求的时间和服务器时间超出15分钟",RequestTimeout:"请求超时",SignatureDoesNotMatch:"签名错误",TooManyBuckets:"Bucket数目超过限制"};return{getError:function(res,status){var error={status:status,code:"",msg:""};if(res){var resError=res.Error;angular.extend(error,{code:resError.Code||"",msg:resError.Message||""});var message=resError.Message;erroList[resError.Code]&&(message=erroList[resError.Code]),angular.extend(error,{msg:message})}else{var msg="";403==status?msg=erroList.AccessDenied:(msg="网络请求错误",OSSConfig.isGuiZhouClient()&&(msg+='<p class="text-muted">（可能是你登录时选择的区域与当前的网络环境不匹配，请退出客户端后重新选择）</p>')),angular.extend(error,{msg:msg})}return error},getClientErrorMsg:function(res){return res.message}}}]).factory("Clipboard",function(){var maxLen=1,container=[];return{clear:function(){container=[]},len:function(){return container.length},get:function(){var item=container.shift();return OSS.log("Clipboard.get",item),item},add:function(data){container.push(data),container.length>maxLen&&container.shift(),OSS.log("Clipboard.add",data)}}}).filter("baseName",function(){return Util.String.baseName}).filter("isDir",function(){return function(path){var lastStr=Util.String.lastChar(path);return"/"===lastStr||"\\"===lastStr?1:0}}).filter("getLocationName",["OSSRegion",function(OSSRegion){return function(location){if(!location)return"";var region=OSSRegion.getRegionByLocation(location);return region?region.name:""}}]).directive("ngRightClick",["$parse",function($parse){return function($scope,$element,$attrs){var fn=$parse($attrs.ngRightClick);$element.bind("contextmenu",function(event){$scope.$apply(function(){event.preventDefault(),fn($scope,{$event:event})})})}}]).directive("scrollLoad",["$rootScope","$parse",function($rootScope,$parse){return{restrict:"A",link:function($scope,$element,attrs){var triggerDistance=0,disableScroll=!1;null!=attrs.triggerDistance&&$scope.$watch(attrs.triggerDistance,function(value){return triggerDistance=parseInt(value||0,10)}),null!=attrs.disableScroll&&$scope.$watch(attrs.disableScroll,function(value){return disableScroll=!!value});var direction="down";attrs.triggerDirection&&(direction=attrs.triggerDirection);var startScrollTop=0,fn=$parse(attrs.scrollLoad);$element.on("scroll.scrollLoad",function(event){var _self=jQuery(this),realDistance=0,scrollH=0,scrollT=0,isScrollDown=!1;scrollH=jQuery.isWindow(this)?document.body.scrollHeight:$element[0].scrollHeight,scrollT=_self.scrollTop(),isScrollDown=scrollT>startScrollTop;var clientHeight=jQuery.isWindow(this)?document.documentElement.clientHeight||document.body.clientHeight:this.clientHeight;realDistance="down"==direction?scrollH-scrollT-clientHeight:scrollT,triggerDistance>=realDistance&&!disableScroll&&(!isScrollDown&&"up"==direction||isScrollDown&&"down"==direction)&&$scope.$apply(function(){fn($scope,{$event:event})}),startScrollTop=scrollT}),$scope.$on("$destroy",function(){$element.off("scroll.scrollLoad")})}}}]).directive("scrollToItem",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attrs){attrs.$observe("scrollToItem",function(newVal){"undefiend"!=typeof newVal&&$timeout(function(){var index=newVal;if(!(0>index)){var $fileItem=element.find(attrs.itemSelector+":eq("+index+")");if($fileItem.size()){var top=$fileItem.position().top,grep=top+$fileItem.height()-element.height();0>top?element.scrollTop(element.scrollTop()+top):grep>0&&element.scrollTop(element.scrollTop()+grep)}}})})}}}]).directive("onDrop",["$parse",function($parse){return function(scope,element,attrs){var fn=$parse(attrs.onDrop);element.on("drop",function(event){scope.$apply(function(){fn(scope,{$event:event})})})}}]).directive("preventDragDrop",[function(){return{restrict:"A",link:function($scope,$element){$element.on("dragstart",function(event){var jTarget=jQuery(event.target);jTarget.attr("draggable")||jTarget.parents("[draggable]").size()||event.preventDefault()}),$element.on("dragover",function(event){event.preventDefault()}),$element.on("dragenter",function(event){event.preventDefault()}),$element.on("drop",function(event){event.preventDefault()})}}}]).directive("autoSelect",[function(){return{restrict:"A",link:function(scope,element,attrs){var isAutoSelect=!1;attrs.$observe("autoSelect",function(isAuto){isAutoSelect=isAuto}),element.on("click.autoSelect",function(){isAutoSelect&&element.select()})}}}]).directive("locationSelect",["OSSRegion",function(OSSRegion){return{restrict:"E",replace:!0,scope:{selectLocation:"=",disableSelect:"=",name:"@",placeHolder:"@",searchDisabled:"=",defaultLocation:"@"},templateUrl:"views/location-select.html",link:function(scope){scope.locations=OSSRegion.list(),scope.$watch("locations.selected",function(val){scope.selectLocation=val}),scope.placeHolder||(scope.locations.selected=scope.locations[0]),scope.$watch("defaultLocation",function(newVal){newVal&&(scope.locations.selected=_.find(scope.locations,function(region){return 0==region.location.indexOf(newVal)}))})}}}]),angular.module("ossClientUiApp",["ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angularSpinner","OSSCommon","angularSpinner","ng-context-menu","ui.select","LocalStorageModule"]).config(["$routeProvider","$httpProvider","uiSelectConfig",function($routeProvider,$httpProvider,uiSelectConfig){uiSelectConfig.theme="bootstrap",$routeProvider.when("/file/:bucket?/?:object*?",{templateUrl:"views/filelist.html",controller:"FileListCtrl",resolve:{buckets:function(Bucket){return Bucket.list()}}}).when("/upload/:bucket",{templateUrl:"views/uploadlist.html",controller:"UploadListCtrl",resolve:{buckets:function(Bucket){return Bucket.list()}}}).otherwise({redirectTo:"/file"}),$httpProvider.defaults.transformResponse.unshift(function(response,header){return"application/xml"==header("content-type")?$.xml2json(response):response})}]),angular.module("ossClientUiApp").controller("MainCtrl",["$scope","usSpinnerService","OSSApi","OSSModal","Bucket","Bread","OSSLocationHistory","$rootScope","$filter","OSSDialog","OSSAlert","OSSLocation","$location","OSSConfig","OSSMenu",function($scope,usSpinnerService,OSSApi,OSSModal,Bucket,Bread,OSSLocationHistory,$rootScope,$filter,OSSDialog,OSSAlert,OSSLocation,$location,OSSConfig,OSSMenu){$scope.showRefer=OSSConfig.showRefer(),$scope.bucketsLoaded=!1,usSpinnerService.spin("body-spinner"),$scope.$on("bucketsLoaded",function(){$scope.bucketsLoaded=!0,usSpinnerService.stop("body-spinner")}),$scope.buckets=[],$scope.showAddBucketModal=function(){OSSModal.addBucket().result.then(function(param){param&&"add"==param.act&&($scope.buckets.push(param.bucket),$scope.scrollToIndex=$scope.buckets.length-1,$location.path(OSSLocation.getUrl(param.bucket.Name)))})},$scope.editBucket=function(bucket){OSSModal.addBucket(bucket).result.then(function(param){param&&"del"==param.act&&Util.Array.removeByValue($scope.buckets,param.bucket)})},$scope.manageBucketPartition=function(activeBucket){var url=OSSLocation.getUrl(activeBucket.Name,"","upload");$location.url(url)},$scope.setRefer=function(bucket){OSSModal.setRefer(bucket)},$scope.downloadBucket=function(bucket){OSSAlert.confirm("确定要下载整个Bucket吗？").result.then(function(){OSSMenu.getMenu("bucketdownload").execute(bucket)})},$scope.onConextMenuShow=function(bucket){$scope.activeBucket=bucket},$scope.breads=[],$scope.backward=function(){OSSLocationHistory.backward()},$scope.forward=function(){OSSLocationHistory.forward()},Bucket.list().then(function(buckets){buckets&&($scope.buckets=angular.isArray(buckets)?buckets:[buckets])}),$scope.breadFilter=function(value){return!value.hide},$scope.$on("$routeChangeSuccess",function(event,current,prev){if(prev&&prev.params){var oldBucket=Bucket.getBucket(prev.params.bucket);oldBucket&&Bucket.unselected(oldBucket)}var currentBucket,currentObjectPath="/",filter="file";if(current&&current.params&&current.params.bucket){if(current.$$route&&current.$$route.originalPath){var pathArr=current.$$route.originalPath.split("/");currentBucket=Bucket.getBucket(current.params.bucket),currentObjectPath=current.params.object,filter=pathArr[1]||"file"}}else $scope.buckets&&$scope.buckets.length&&(currentBucket=$scope.buckets[0].Name);currentBucket&&(Bucket.select(currentBucket),$scope.breads=Bread.getBreads(currentBucket.Name,currentObjectPath,filter),$scope.historyCanForward=OSSLocationHistory.canForward(),$scope.historyCanBackward=OSSLocationHistory.canBackward())}),$scope.exportAuthorization=function(){OSSModal.setting()},$scope.$on("toggleTransQueue",function(event,isShow){$scope.showTransQueue=angular.isUndefined(isShow)?!$scope.showTransQueue:isShow}),$scope.$on("showError",function(event,errorMsg,errorTitle){errorMsg&&OSSAlert.error(errorMsg,errorTitle)}),$scope.$on("removeBucket",function(event,bucket){Util.Array.removeByValue($scope.buckets,bucket),bucket.selected&&$scope.buckets.length&&$location.path(OSSLocation.getUrl($scope.buckets[0].Name))}),$scope.currentLocation=OSS.invoke("getCurrentLocation")}]).controller("TransQueueCtrl",["$scope","$interval","OSSQueueMenu","OSSUploadQueue","OSSDownloadQueue","$rootScope",function($scope,$interval,OSSQueueMenu,OSSUploadQueue,OSSDownloadQueue,$rootScope){$scope.uploadQueueMenus=OSSQueueMenu.getUploadMenu(),$scope.uploadMenuGroup=OSSQueueMenu.groupBy($scope.uploadQueueMenus,"upload"),$scope.downloadQueueMenus=OSSQueueMenu.getDownloadMenu(),$scope.downloadMenuGroup=OSSQueueMenu.groupBy($scope.downloadQueueMenus,"download"),$scope.getSelectedList=function(type){return _.where("download"==type?$scope.downloadList:$scope.uploadList,{selected:!0})},$scope.select=function(item,type){item.selected=!0,"download"==type?$scope.scrollToDownloadIndex=_.indexOf($scope.downloadList,item):$scope.scrollToUploadIndex=_.indexOf($scope.uploadList,item)},$scope.unSelect=function(item){item.selected=!1},$scope.unSelectAll=function(type){angular.forEach($scope.getSelectedList(type),function(item){$scope.unSelect(item,type)})},$scope.shiftLastUploadIndex=0,$scope.shiftLastDownloadIndex=0,$scope.handleItemClick=function($event,index,item,type){if($event.ctrlKey||$event.metaKey)item.selected?$scope.unSelect(item,type):$scope.select(item,type);else if($event.shiftKey){var lastIndex="download"==type?$scope.shiftLastDownloadIndex:$scope.shiftLastUploadIndex;if($scope.unSelectAll(type),index>lastIndex)for(var i=lastIndex;index>=i;i++)$scope.select("download"==type?$scope.downloadList[i]:$scope.uploadList[i],type);else if(lastIndex>index)for(var i=index;lastIndex>=i;i++)$scope.select("download"==type?$scope.downloadList[i]:$scope.uploadList[i],type)}else $scope.unSelectAll(type),$scope.select(item,type);$event.shiftKey||("download"==type?$scope.shiftLastDownloadIndex=index:$scope.shiftLastUploadIndex=index)},$scope.$on("removeQueue",function(event,type,items,callback){"upload"===type?angular.forEach(items,function(item){OSSUploadQueue.remove(item)}):angular.forEach(items,function(item){OSSDownloadQueue.remove(item)}),angular.isFunction(callback)&&callback()}),$scope.OSSUploadQueue=OSSUploadQueue.init(),$scope.uploadList=$scope.OSSUploadQueue.items,$scope.OSSUploadQueue.refresh(),$scope.$on("reloadUploadQueue",function(){$scope.OSSUploadQueue=OSSUploadQueue.init(),$scope.uploadList=$scope.OSSUploadQueue.items}),$scope.OSSDownloadQueue=OSSDownloadQueue.init(),$scope.downloadList=$scope.OSSDownloadQueue.items,$scope.OSSDownloadQueue.refresh(),$scope.$on("reloadDownloadQueue",function(){$scope.OSSDownloadQueue=OSSDownloadQueue.init(),$scope.downloadList=$scope.OSSDownloadQueue.items}),$scope.loadMoreQueue=function(type){"download"==type?($scope.loadingQueue=!0,$scope.OSSDownloadQueue.getQueueList($scope.downloadList.length),$scope.loadingQueue=!1):"upload"==type&&($scope.loadingQueue=!0,$scope.OSSUploadQueue.getQueueList($scope.uploadList.length),$scope.loadingQueue=!1)},$scope.toggleSlideQueue=function(){$scope.$emit("toggleTransQueue")},$scope.handleTransQueueDblClick=function($event){var $target=$($event.target);($target.hasClass("nav-tabs")||$target.parents(".nav").size())&&$scope.toggleSlideQueue()},$scope.tabs=[{name:"upload",title:"上传队列"},{name:"download",title:"下载队列"},{name:"log",title:"错误日志"}],$scope.$on("toggleTransQueue",function($event,isShow,currentTab){if(!angular.isUndefined(currentTab)){var tab=_.findWhere($scope.tabs,{name:currentTab});tab&&!tab.selected&&(tab.active=!0),"upload"==tab?$scope.scrollToUploadIndex=$scope.uploadList.length-1:"download"===tab&&($scope.scrollToDownloadIndex=$scope.downloadList.length-1)}}),$scope.openLogFolder=function(){OSS.invoke("openLogFolder")},$scope.errorLog="";var selectCount=0;$scope.selectTab=function(tab){if("log"==tab.name){var errorLog="",res=OSS.invoke("getErrorLog");res&&res.list&&res.list.length&&(angular.forEach(res.list,function(val){errorLog+=val.msg+"\r\n"}),$scope.errorLog=errorLog)}else"upload"==tab.name||"download"==tab.name;!$rootScope.showTransQueue&&selectCount>0&&$scope.$emit("toggleTransQueue",!0),selectCount++},$scope.executeDownloadCmd=function(cmd,item){var menu=OSSQueueMenu.getDownloadMenuItem(cmd);menu&&menu.execute([item])},$scope.executeUploadCmd=function(cmd,item){var menu=OSSQueueMenu.getUploadMenuItem(cmd);menu&&menu.execute([item])};var excludeMenus=[];$scope.isExcludeTopMenu=function(menu){return _.indexOf(excludeMenus,menu.name)>=0},$scope.clearDone=function(type){var menu,list=[];"download"==type?(menu=OSSQueueMenu.getDownloadMenuItem("remove"),list=_.filter($scope.downloadList,function(item){return _.indexOf([4,5],item.status)>=0})):(menu=OSSQueueMenu.getUploadMenuItem("remove"),list=_.filter($scope.uploadList,function(item){return _.indexOf([4,5],item.status)>=0})),menu&&list.length&&menu.execute(list)}}]).controller("FileListCtrl",["$scope","$routeParams","localStorageService","OSSApi","buckets","$rootScope","OSSObject","OSSMenu","Bucket","$route","$location","OSSLocation","usSpinnerService","$filter","OSSException","$timeout",function($scope,$routeParams,localStorageService,OSSApi,buckets,$rootScope,OSSObject,OSSMenu,Bucket,$route,$location,OSSLocation,usSpinnerService,$filter,OSSException,$timeout){var bucketName=$routeParams.bucket||"",keyword=$routeParams.keyword||"",prefix="",delimiter="/",isSearch=!1,loadFileCount=500,lastLoadMaker="",isAllFileLoaded=!1;if($scope.showTip=1==localStorageService.get("hide-tip")?!1:!0,$scope.tipContent='<i class="fa fa-info-circle"></i> <span>小技巧：使用Shift和Ctrl键(Mac下Command键)可以实现多选操作。</span>',$scope.disableTip=function(){$scope.showTip=!1,localStorageService.set("hide-tip",1)},$scope.orderBy="",buckets.length&&!bucketName)return void $location.path(OSSLocation.getUrl(buckets[0].Name));$scope.bucket=Bucket.getBucket(bucketName),$scope.objectPrefix=$routeParams.object?$routeParams.object:"",OSSObject.setCurrentObject({path:$scope.objectPrefix,dir:1}),keyword.length?(prefix=$scope.objectPrefix+keyword,isSearch=!0):(prefix=$scope.objectPrefix,isSearch=!1),$scope.files=[];var loadFile=function(){$scope.loadingFile||($scope.loadingFile=!0,usSpinnerService.spin("file-list-spinner"),OSSObject.list($scope.bucket,prefix,delimiter,lastLoadMaker,loadFileCount).then(function(res){$scope.loadingFile=!1,$scope.files=$filter("orderBy")($scope.files.concat(res.files),$scope.orderBy),lastLoadMaker=res.marker,isAllFileLoaded=res.allLoaded,usSpinnerService.stop("file-list-spinner")},function(){$scope.$emit("showError","无法访问该Bucket"),$scope.loadingFile=!1,usSpinnerService.stop("file-list-spinner")}))};loadFile(),$scope.openFile=function(file,isDir){if(1==isDir)OSSObject.open($scope.bucket,file.path,isDir);else{var menu=OSSMenu.getMenu("download");menu&&menu.execute($scope.bucket,$scope.objectPrefix,[file])}},$scope.loadMoreFile=function(){isAllFileLoaded||loadFile()},$scope.$watch("orderBy",function(val){$scope.files=$filter("orderBy")($scope.files,val)}),$scope.enableKeyBoardNav=1,$scope.getSelectedList=function(){return _.where($scope.files,{selected:!0})},$scope.select=function(item){item.selected=!0,$scope.scrollToIndex=_.indexOf($scope.files,item)},$scope.unSelect=function(item){item.selected=!1},$scope.unSelectAll=function(){angular.forEach($scope.getSelectedList(),function(item){$scope.unSelect(item)})},$scope.shiftLastIndex=0,$scope.handleClick=function($event,file,index){if($event.ctrlKey||$event.metaKey)file.selected?$scope.unSelect(file):$scope.select(file);else if($event.shiftKey){var lastIndex=$scope.shiftLastIndex;if($scope.unSelectAll(),index>lastIndex)for(var i=lastIndex;index>=i;i++)$scope.select($scope.files[i]);else if(lastIndex>index)for(var i=index;lastIndex>=i;i++)$scope.select($scope.files[i])}else $scope.unSelectAll(),$scope.select(file);$event.shiftKey||($scope.shiftLastIndex=index)},$scope.onContextMenuShow=function(file){file.selected||($scope.unSelectAll(),$scope.select(file))},$scope.currentFileMenuList=OSSMenu.getCurrentFileMenu(),$scope.selectFileMenuList=OSSMenu.getSelectFileMenu(),$scope.menuGroups=OSSMenu.groupMenu(_.union($scope.currentFileMenuList,$scope.selectFileMenuList)),$scope.excludeTopMenu=OSSMenu.getTopExcludeMenus(),$scope.isExclude=function(menu){return $scope.excludeTopMenu.indexOf(menu.name)>=0},$scope.$on("reloadFileList",function(){$route.reload()}),$scope.$on("createObject",function(event,callback){$timeout(function(){$scope.showCreateFile=!0,$scope.createFileCallback=callback})}),$scope.$on("addObject",function(event,objects,selected){objects=$.isArray(objects)?objects:[objects];var addFiles=_.map(objects,OSSObject.format);angular.forEach(addFiles,function(file){$scope.files.push(file),selected&&$scope.select(file)})}),$scope.$on("removeObject",function(event,objects){angular.forEach(objects,function(object){Util.Array.removeByValue($scope.files,object)})}),$scope.handleSysDrop=function(){var dragFiles=OSS.invoke("getDragFiles"),params={location:$scope.bucket.Location,bucket:$scope.bucket.Name,prefix:$scope.objectPrefix,list:dragFiles.list};OSS.invoke("addFile",params,function(res){res.error?$rootScope.$broadcast("showError",OSSException.getClientErrorMsg(res)):($rootScope.$broadcast("toggleTransQueue",!0),$rootScope.$broadcast("reloadUploadQueue"))})},$scope.handleFileListClick=function($event){$($event.target).closest(".file-item").size()||$scope.unSelectAll()}}]).controller("UploadListCtrl",["$scope","usSpinnerService","$routeParams","OSSUploadPart","Bucket","OSSUploadMenu","OSSException",function($scope,usSpinnerService,$routeParams,OSSUploadPart,Bucket,OSSUploadMenu,OSSException){$scope.loading=!1;var isAllLoaded=!1,lastKeyMaker="",lastUploadMaker="",loadCount=100,bucketName=$routeParams.bucket,loadUploads=function(){$scope.loading||($scope.loading=!0,usSpinnerService.spin("upload-list-spinner"),OSSUploadPart.list(Bucket.getBucket(bucketName),"","",lastKeyMaker,loadCount,lastUploadMaker).then(function(res){$scope.loading=!1,usSpinnerService.stop("upload-list-spinner"),$scope.uploads=$scope.uploads.concat(res.uploads),lastKeyMaker=res.keyMaker,lastUploadMaker=res.uploadIdMaker,isAllLoaded=res.allLoaded},function(res,status){$scope.loading=!1,usSpinnerService.stop("upload-list-spinner"),$scope.$emit("showError",OSSException.getError(res,status).msg)}))};$scope.uploads=[],$scope.loadMoreUpload=function(){isAllLoaded||loadUploads()},loadUploads(),$scope.enableKeyBoardNav=1,$scope.getSelectedList=function(){return _.where($scope.uploads,{selected:!0})},$scope.select=function(item){item.selected=!0},$scope.unSelect=function(item){item.selected=!1},$scope.unSelectAll=function(){angular.forEach($scope.getSelectedList(),function(item){$scope.unSelect(item)})},$scope.handleClick=function($event,upload,index){if($event.ctrlKey||$event.metaKey)upload.selected?$scope.unSelect(upload):$scope.select(upload);else if($event.shiftKey){var lastIndex=$scope.shiftLastIndex;if($scope.unSelectAll(),index>lastIndex)for(var i=lastIndex;index>=i;i++)$scope.select($scope.uploads[i]);else if(lastIndex>index)for(var i=index;lastIndex>=i;i++)$scope.select($scope.uploads[i])}else $scope.unSelectAll(),$scope.select(upload);$event.shiftKey||($scope.shiftLastIndex=index)},$scope.topMenuList=OSSUploadMenu.getAllMenu(),$scope.$on("removeUpload",function(event,uploads){angular.isArray(uploads)||(uploads=[uploads]),angular.forEach(uploads,function(upload){var index=_.indexOf($scope.uploads,upload);index>=0&&$scope.uploads.splice(index,1)})}),$scope.onContextMenuShow=function(upload){upload.selected||($scope.unSelectAll(),$scope.select(upload))}}]),angular.module("ossClientUiApp").factory("OSSAlert",["$modal",function($modal){function openAlertModal(type,message,title,buttons){var option={templateUrl:"views/alert_modal.html",windowClass:"alert-modal "+type+"-alert-modal",controller:function($scope,$modalInstance){$scope.type=type,$scope.message=message,$scope.title=title,$scope.buttons=buttons,$scope.buttonClick=function(button){angular.isFunction(button.callback)?button.callback($modalInstance):$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};return $modal.open(option)}return{confirm:function(message,title){title=angular.isUndefined(title)?"请确认":title;var buttons=[{text:"确定",classes:"btn btn-primary",callback:function($modalInstance){$modalInstance.close()}},{text:"取消",classes:"btn btn-default",callback:function($modalInstance){$modalInstance.dismiss("cancel")}}];return openAlertModal("warning",message,title,buttons)},info:function(message,title,buttons){return title=angular.isUndefined(title)?"信息":title,buttons=angular.isUndefined(buttons)?[{text:"关闭",classes:"btn btn-default"}]:buttons,openAlertModal("info",message,title,buttons)},warning:function(message,title,buttons){return title=angular.isUndefined(title)?"警告":title,buttons=angular.isUndefined(buttons)?[{text:"确认",classes:"btn btn-primary"},{text:"关闭",classes:"btn btn-default"}]:buttons,openAlertModal("warning",message,title,buttons)},error:function(message,title,buttons){return title=angular.isUndefined(title)?"错误":title,buttons=angular.isUndefined(buttons)?[{text:"关闭",classes:"btn btn-default"}]:buttons,openAlertModal("error",message,title,buttons)},success:function(message,title,buttons){return title=angular.isUndefined(title)?"成功":title,buttons=angular.isUndefined(buttons)?[{text:"关闭",classes:"btn btn-default"}]:buttons,openAlertModal("success",message,title,buttons)}}}]).factory("OSSUploadQueue",["$rootScope","$timeout","OSSQueueItem","OSSLocation","$filter",function($rootScope,$timeout,OSSQueueItem,OSSLocation,$filter){var size=100,OSSUploadQueue={items:[],totalCount:0,doneCount:0,uploadSpeed:0,downloadSpeed:0,isStop:!0,init:function(){return this.getQueueList(0),this},getQueueList:function(start){var res=OSS.invoke("getUpload",{start:start,count:size});OSS.log("OSSUploadQueue",res);var list=angular.isArray(res.list)?res.list:[];0==start?this.items=list:angular.forEach(list,function(item){OSSUploadQueue.add(item)}),this.totalCount=res.upload_total_count,this.doneCount=res.upload_done_count,this.uploadSpeed=res.upload,this.downloadSpeed=res.download},add:function(item){this.items.push(item)},get:function(pathhash){return _.findWhere(this.items,{pathhash:pathhash})},remove:function(item){var index=_.indexOf(this.items,item);index>-1&&this.items.splice(index,1)},update:function(item,param){angular.extend(item,param)},refresh:function(){var _self=this;OSS.invoke("changeUpload",{start:1},function(res){$timeout(function(){angular.forEach(res.list,function(val){var existItem=_self.get(val.pathhash);existItem&&_self.update(existItem,val);var upPath=Util.String.dirName($filter("isDir")(val.object)?Util.String.dirName(val.object):val.object);OSSQueueItem.isDone(val)&&OSSLocation.isCurrentObject(val.bucket,upPath)&&$rootScope.$broadcast("reloadFileList")}),_self.totalCount=res.upload_total_count,_self.doneCount=res.upload_done_count,_self.uploadSpeed=res.upload,_self.downloadSpeed=res.download})},!1),this.isStop=!1},stop:function(){OSS.invoke("changeUpload",{start:0}),this.isStop=!0},isStoped:function(){return this.isStop}};return OSSUploadQueue}]).factory("OSSQueueItem",[function(){var STATUS_ERROR=5,STATUS_PROGRESS=1,STATUS_DONE=4,STATUS_WAITING=2,STATUS_PASUED=3,OSSQueueItem={setStatus:function(item,status){item.status=status},isError:function(item){return item.status==STATUS_ERROR},isInProgress:function(item){return item.status==STATUS_PROGRESS},isDone:function(item){return item.status==STATUS_DONE},isWaiting:function(item){return item.status==STATUS_WAITING},isPaused:function(item){return item.status==STATUS_PASUED},setError:function(item){OSSQueueItem.setStatus(item,STATUS_ERROR)},setProgress:function(item){OSSQueueItem.setStatus(item,STATUS_PROGRESS)},setDone:function(item){OSSQueueItem.setStatus(item,STATUS_DONE)},setWaiting:function(item){OSSQueueItem.setStatus(item,STATUS_WAITING)},setPaused:function(item){OSSQueueItem.setStatus(item,STATUS_PASUED)}};return OSSQueueItem}]).factory("OSSDownloadQueue",["$rootScope","$timeout",function($rootScope,$timeout){var size=100,OSSDownloadQueue={items:[],totalCount:0,doneCount:0,uploadSpeed:0,downloadSpeed:0,isStop:!0,init:function(){return this.getQueueList(0),this
},getQueueList:function(start){var res=OSS.invoke("getDownload",{start:start,count:size}),list=angular.isArray(res.list)?res.list:[];0==start?this.items=list:angular.forEach(list,function(item){OSSDownloadQueue.add(item)}),this.totalCount=res.download_total_count,this.doneCount=res.download_done_count,this.uploadSpeed=res.upload,this.downloadSpeed=res.download},add:function(item){this.items.push(item)},get:function(fullpath){return _.findWhere(this.items,{fullpath:fullpath})},remove:function(item){var index=_.indexOf(this.items,item);index>-1&&this.items.splice(index,1)},update:function(item,param){angular.extend(item,param)},refresh:function(){var _self=this;this.isStop=!1,OSS.invoke("changeDownload",{start:1},function(res){$timeout(function(){angular.forEach(res.list,function(val){var existItem=_self.get(val.fullpath);existItem&&_self.update(existItem,val)}),_self.totalCount=res.download_total_count,_self.doneCount=res.download_done_count,_self.uploadSpeed=res.upload,_self.downloadSpeed=res.download})},!1)},stop:function(){OSS.invoke("changeDownload",{start:0}),this.isStop=!0},isStoped:function(){return this.isStop}};return OSSDownloadQueue}]).factory("OSSQueueMenu",["$rootScope","OSSQueueItem","$timeout","OSSAlert","OSSDownloadQueue","OSSUploadQueue",function($rootScope,OSSQueueItem,$timeout,OSSAlert){var checkArgValid=function(selectedItems){return angular.isArray(selectedItems)&&selectedItems.length?!0:!1},prepareUpladParam=function(selectedItems,finish){var param={all:selectedItems&&selectedItems.length?0:1};return"undefined"!=typeof finish&&angular.extend(param,{finish:finish}),selectedItems&&(param.list=[],angular.forEach(selectedItems,function(item){param.list.push({bucket:item.bucket,object:item.object})})),param},prepareDownloadParam=function(selectedItems,finish){var param={all:selectedItems&&selectedItems.length?0:1};return"undefined"!=typeof finish&&angular.extend(param,{finish:finish}),selectedItems&&(param.list=[],angular.forEach(selectedItems,function(item){param.list.push({fullpath:item.fullpath})})),param},uploadMenu=[{name:"start",text:"开始",execute:function(selectedItems){checkArgValid(selectedItems)&&OSS.invoke("startUpload",prepareUpladParam(selectedItems),function(){$timeout(function(){_.each(selectedItems,OSSQueueItem.setProgress)})})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return-1;for(var hasUnValidItem=!1,i=0;i<selectedItems.length;i++){var item=selectedItems[i];OSSQueueItem.isPaused(item)||(hasUnValidItem=!0)}return hasUnValidItem?-1:1}},{name:"pause",text:"暂停",execute:function(selectedItems){checkArgValid(selectedItems)&&OSS.invoke("stopUpload",prepareUpladParam(selectedItems),function(){$timeout(function(){_.each(selectedItems,OSSQueueItem.setPaused)})})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return 0;for(var hasUnValidItem=!1,count=0,i=0;i<selectedItems.length;i++){var item=selectedItems[i];(OSSQueueItem.isPaused(item)||OSSQueueItem.isError(item)||OSSQueueItem.isDone(item))&&(hasUnValidItem=!0,OSSQueueItem.isPaused(item)&&count++)}return hasUnValidItem?count==selectedItems.length?-1:0:1}},{name:"cancel",text:"取消",execute:function(selectedItems){var msg="你确定要取消"+(1==selectedItems.length?"这个":"这"+selectedItems.length+"个")+"文件的上传？";OSSAlert.confirm(msg).result.then(function(){checkArgValid(selectedItems)&&OSS.invoke("deleteUpload",prepareUpladParam(selectedItems),function(){$timeout(function(){$rootScope.$broadcast("removeQueue","upload",selectedItems)})})},function(){})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return 0;var doneItemsList=_.filter(selectedItems,function(item){return OSSQueueItem.isDone(item)||OSSQueueItem.isError(item)}),progressList=_.filter(selectedItems,function(item){return OSSQueueItem.isWaiting(item)||OSSQueueItem.isInProgress(item)||OSSQueueItem.isPaused(item)});return doneItemsList&&doneItemsList.length==selectedItems.length?-1:progressList&&progressList.length==selectedItems.length?1:0}},{name:"remove",text:"移除",execute:function(selectedItems){checkArgValid(selectedItems)&&OSS.invoke("deleteUpload",prepareUpladParam(selectedItems),function(){$timeout(function(){$rootScope.$broadcast("removeQueue","upload",selectedItems)})})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return-1;var doneItemsList=_.filter(selectedItems,function(item){return OSSQueueItem.isDone(item)||OSSQueueItem.isError(item)});return doneItemsList&&doneItemsList.length==selectedItems.length?1:-1}},{name:"pauseAll",text:"全部暂停",execute:function(selectedItems,items){OSS.invoke("stopUpload",prepareUpladParam(),function(){$timeout(function(){_.each(_.filter(items,function(item){return OSSQueueItem.isWaiting(item)||OSSQueueItem.isInProgress(item)}),OSSQueueItem.setPaused)})})},getState:function(selectItems,items){return items&&items.length?1:0}},{name:"startAll",text:"全部开始",execute:function(selectedItems,items){OSS.invoke("startUpload",prepareUpladParam(),function(){$timeout(function(){_.each(_.filter(items,function(item){return OSSQueueItem.isPaused(item)}),OSSQueueItem.setPaused)})})},getState:function(selectItems,items){return items&&items.length?1:0}},{name:"stopAll",text:"全部取消",execute:function(){var msg="你确定要取消所有上传？";OSSAlert.confirm(msg).result.then(function(){OSS.invoke("deleteUpload",prepareUpladParam(!1,0),function(){$timeout(function(){$rootScope.$broadcast("reloadUploadQueue")})})})},getState:function(selectItems,items){return items&&items.length?1:0}},{name:"removeAll",text:"清空已完成",execute:function(selectItems,items){OSS.invoke("deleteUpload",{finish:1,all:1},function(){$timeout(function(){$rootScope.$broadcast("removeQueue","upload",_.filter(items,function(item){return OSSQueueItem.isDone(item)}),function(){$rootScope.$broadcast("reloadUploadQueue")})})})},getState:function(selectItems,items){return items&&items.length?1:0}}],downloadMenu=[{name:"start",text:"开始",execute:function(selectedItems){checkArgValid(selectedItems)&&OSS.invoke("startDownload",prepareDownloadParam(selectedItems),function(){$timeout(function(){_.each(selectedItems,OSSQueueItem.setProgress)})})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return-1;for(var hasUnValidItem=!1,i=0;i<selectedItems.length;i++){var item=selectedItems[i];OSSQueueItem.isPaused(item)||(hasUnValidItem=!0)}return hasUnValidItem?-1:1}},{name:"pause",text:"暂停",execute:function(selectedItems){checkArgValid(selectedItems)&&OSS.invoke("stopDownload",prepareDownloadParam(selectedItems),function(){$timeout(function(){_.each(selectedItems,OSSQueueItem.setPaused)})})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return 0;for(var hasUnValidItem=!1,count=0,i=0;i<selectedItems.length;i++){var item=selectedItems[i];(OSSQueueItem.isPaused(item)||OSSQueueItem.isError(item)||OSSQueueItem.isDone(item))&&(hasUnValidItem=!0,OSSQueueItem.isPaused(item)&&count++)}return hasUnValidItem?count==selectedItems.length?-1:0:1}},{name:"cancel",text:"取消",execute:function(selectedItems){var msg="你确定要取消"+(1==selectedItems.length?"这个":"这"+selectedItems.length+"个")+"文件的下载？";OSSAlert.confirm(msg).result.then(function(){checkArgValid(selectedItems)&&OSS.invoke("deleteDownload",prepareDownloadParam(selectedItems),function(){$timeout(function(){$rootScope.$broadcast("removeQueue","download",selectedItems)})})})},getState:function(selectedItems){if(!selectedItems||!selectedItems.length)return 0;var doneItemsList=_.filter(selectedItems,function(item){return OSSQueueItem.isDone(item)||OSSQueueItem.isError(item)}),progressList=_.filter(selectedItems,function(item){return OSSQueueItem.isWaiting(item)||OSSQueueItem.isInProgress(item)||OSSQueueItem.isPaused(item)});return doneItemsList&&doneItemsList.length==selectedItems.length?-1:progressList&&progressList.length==selectedItems.length?1:0}},{name:"remove",text:"移除",execute:function(selectedItems){checkArgValid(selectedItems)&&OSS.invoke("deleteDownload",prepareDownloadParam(selectedItems),function(){$timeout(function(){$rootScope.$broadcast("removeQueue","download",selectedItems)})})},getState:function(selectedItems){var len=selectedItems.length;if(!len)return-1;var doneItemsList=_.filter(selectedItems,function(item){return OSSQueueItem.isDone(item)||OSSQueueItem.isError(item)});return doneItemsList&&doneItemsList.length==selectedItems.length?1:-1}},{name:"pauseAll",text:"全部暂停",execute:function(selectItems,items){OSS.invoke("stopDownload",prepareDownloadParam(),function(){$timeout(function(){_.each(_.filter(items,function(item){return OSSQueueItem.isWaiting(item)||OSSQueueItem.isInProgress(item)}),OSSQueueItem.setPaused)})})},getState:function(selectItems,items){return items&&items.length?1:0}},{name:"startAll",text:"全部开始",execute:function(selectItems,items){OSS.invoke("startDownload",prepareDownloadParam(),function(){_.each(_.filter(items,function(item){return OSSQueueItem.isPaused(item)}),OSSQueueItem.setProgress)})},getState:function(selectItems,items){return items&&items.length?1:0}},{name:"stopAll",text:"全部取消",execute:function(){var msg="你确定要取消所有下载？";OSSAlert.confirm(msg).result.then(function(){OSS.invoke("deleteDownload",prepareDownloadParam(!1,0),function(){$timeout(function(){$rootScope.$broadcast("reloadDownloadQueue")})})})},getState:function(selectItems,items){return items&&items.length?1:0}},{name:"removeAll",text:"清空已完成",execute:function(selectItems,items){OSS.invoke("deleteDownload",{finish:1,all:1},function(){$timeout(function(){$rootScope.$broadcast("removeQueue","download",_.filter(items,function(item){return OSSQueueItem.isDone(item)}),function(){$rootScope.$broadcast("reloadDownloadQueue")})})})},getState:function(selectItems,items){return items&&items.length?1:0}}],groupMenu=[["start","pause","cancel","remove"],["startAll","pauseAll","stopAll","removeAll"]],OSSQueueMenu={getUploadMenu:function(){return uploadMenu},getDownloadMenu:function(){return downloadMenu},getUploadMenuItem:function(name){return _.findWhere(uploadMenu,{name:name})},getDownloadMenuItem:function(name){return _.findWhere(downloadMenu,{name:name})},groupBy:function(menus){var groupMenus=[];return angular.forEach(groupMenu,function(val,key){groupMenus[key]||(groupMenus[key]=[]),angular.forEach(val,function(menuName){groupMenus[key].push(_.findWhere(menus,{name:menuName}))})}),groupMenus}};return OSSQueueMenu}]).factory("OSSMenu",["Clipboard","OSSAlert","OSSModal","$rootScope","OSSApi","OSSException","OSSConfig",function(Clipboard,OSSAlert,OSSModal,$rootScope,OSSApi,OSSException,OSSConfig){var currentMenus="upload create paste".split(" "),selectMenus="download copy del get_uri set_header paste".split(" "),groupMenu=["upload create".split(" "),"download copy del".split(" "),"get_uri set_header".split(" "),"paste".split(" ")],allMenu=[{name:"upload",text:"上传",getState:function(){return 1},execute:function(bucket,currentObject){OSS.invoke("selectFileDlg",{path:"",disable_root:1},function(res){res&&res.list&&res.list.length&&OSS.invoke("addFile",{location:bucket.Location,bucket:bucket.Name,prefix:currentObject,list:res.list},function(res){res.error?$rootScope.$broadcast("showError",OSSException.getClientErrorMsg(res)):($rootScope.$broadcast("toggleTransQueue",!0,"upload"),$rootScope.$broadcast("reloadUploadQueue"))})})}},{name:"create",text:"新建文件夹",getState:function(){return 1},execute:function(bucket,currentObject){$rootScope.$broadcast("createObject",function(filename,callback){var msg="文件夹名称格式错误";if(msg+='<p class="text-muted">',msg+="1. 只能包含字母，数字，中文，下划线（_）和短横线（-）,小数点（.）<br/>",msg+="2. 只能以字母、数字或者中文开头<br/>",msg+="3. 文件夹的长度限制在1-254之间<br/>",msg+="4. Object总长度必须在1-1023之间<br/>",msg+="</p>",!/^[a-zA-Z0-9\u4e00-\u9fa5][a-zA-Z0-9\u4e00-\u9fa5_\-.]{0,253}$/.test(filename))return $rootScope.$broadcast("showError",msg),void($.isFunction(callback)&&callback(!1));if(Util.String.mbLen(filename)>254)return $rootScope.$broadcast("showError",msg),void($.isFunction(callback)&&callback(!1));var objectPath=currentObject?currentObject+filename+"/":filename+"/";return Util.String.mbLen(objectPath)>1023?($rootScope.$broadcast("showError",msg),void($.isFunction(callback)&&callback(!1))):void OSSApi.getObjectMeta(bucket,objectPath).success(function(){$rootScope.$broadcast("showError","已存在相同名称的文件夹"),$.isFunction(callback)&&callback(!1)}).error(function(response,statusCode){var error=OSSException.getError(response,statusCode);return 404!=error.status?($rootScope.$broadcast("showError",error.msg),void($.isFunction(callback)&&callback(!1))):void OSSApi.putObject(bucket,objectPath,{"Content-Type":""},"").success(function(){$.isFunction(callback)&&callback(!0),$rootScope.$broadcast("addObject",{Prefix:objectPath},!0)}).error(function(res,status){$.isFunction(callback)&&callback(!1),$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)})})})}},{name:"bucketdownload",text:"下载",getState:function(){return 1},execute:function(bucket){var list=[{location:bucket.Location,bucket:bucket.Name,object:""}];OSS.invoke("saveFile",{list:list},function(res){res.error?$rootScope.$broadcast("showError",OSSException.getClientErrorMsg(res)):($rootScope.$broadcast("toggleTransQueue",!0,"download"),$rootScope.$broadcast("reloadDownloadQueue"))})}},{name:"download",text:"下载",getState:function(selectedFiles){var len=selectedFiles.length;return len?1:0},execute:function(bucket,currentObject,selectedFiles){var list=_.map(selectedFiles,function(val){return{location:bucket.Location,bucket:bucket.Name,object:val.path,filesize:val.size,etag:val.etag}});OSS.invoke("saveFile",{list:list},function(res){res.error?$rootScope.$broadcast("showError",OSSException.getClientErrorMsg(res)):($rootScope.$broadcast("toggleTransQueue",!0,"download"),$rootScope.$broadcast("reloadDownloadQueue"))})}},{name:"copy",text:"复制",getState:function(selectedFiles){var len=selectedFiles.length;return len?1:0},execute:function(bucket,currentObject,selectedFiles){var data=JSON.stringify({ac:"copy",bucket:bucket,objects:selectedFiles});Clipboard.add(data)}},{name:"paste",text:"粘贴",getState:function(){return Clipboard.len()?1:-1},execute:function(bucket,currentObject,selectedFiles){var clipData=Clipboard.get();if(clipData&&(clipData=JSON.parse(clipData),"copy"==clipData.ac)){var targetBucket=clipData.bucket,list=clipData.objects.map(function(object){return{object:object.path,filesize:object.filesize}});if(bucket.Location!=targetBucket.Location)return void $rootScope.$broadcast("showError","不同区域的Bucket之间不能复制");var copyToCurrent=1==selectedFiles.length&&selectedFiles[0].dir?!1:!0;OSS.invoke("copyObject",{dstbucket:bucket.Name,dstobject:copyToCurrent?currentObject:selectedFiles[0].path,dstlocation:bucket.Location,bucket:targetBucket.Name,location:targetBucket.Location,list:list},function(res){res.error?$rootScope.$broadcast("showError",OSSException.getClientErrorMsg(res)):copyToCurrent&&$rootScope.$broadcast("reloadFileList")})}}},{name:"del",text:"删除",getState:function(selectedFiles){var len=selectedFiles.length;return len?1:0},execute:function(bucket,currentObject,selectedFiles){OSSAlert.confirm("确定要删除？").result.then(function(){var list=_.map(selectedFiles,function(object){return{object:object.path}});OSS.invoke("deleteObject",{bucket:bucket.Name,location:bucket.Location,list:list},function(res){res.error?$rootScope.$broadcast("showError",OSSException.getClientErrorMsg(res)):$rootScope.$broadcast("removeObject",selectedFiles)})})}},{name:"get_uri",text:"获取地址",getState:function(selectedFiles){var len=selectedFiles.length;return!len||len>1?0:selectedFiles[0].dir?0:1},execute:function(bucket,currentObject,selectedFiles){OSSModal.getObjectURI(bucket,selectedFiles[0])}},{name:"set_header",text:"设置HTTP头",getState:function(selectedFiles){var len=selectedFiles.length;return!len||len>1?0:selectedFiles[0].dir?0:1},execute:function(bucket,currentObject,selectedFiles){OSSModal.setObjectHttpHeader(bucket,selectedFiles[0])}}];if(OSSConfig.showRefer()){var referSetting={name:"refer",text:"Refer设置",getState:function(){return 1},execute:function(bucket){OSSModal.setRefer(bucket)}};allMenu.splice(0,0,referSetting),currentMenus=currentMenus.concat(["refer"]),groupMenu[0].push("refer")}return{getAllMenu:function(){return allMenu},getCurrentFileMenu:function(){return _.filter(allMenu,function(menu){return _.indexOf(currentMenus,menu.name)>=0})},getSelectFileMenu:function(){return _.filter(allMenu,function(menu){return _.indexOf(selectMenus,menu.name)>=0})},getMenu:function(name){return _.findWhere(allMenu,{name:name})},groupMenu:function(menus){var groupMenus=[];return angular.forEach(groupMenu,function(val,key){groupMenus[key]||(groupMenus[key]=[]),angular.forEach(val,function(menuName){groupMenus[key].push(_.findWhere(menus,{name:menuName}))})}),groupMenus},getTopExcludeMenus:function(){return[]}}}]).factory("OSSUploadMenu",["Bucket","OSSAlert","OSSApi","$rootScope","OSSModal","OSSException",function(Bucket,OSSAlert,OSSApi,$rootScope,OSSModal,OSSException){var allMenu=[{name:"remove",text:"删除",getState:function(selectedUploads){var len=selectedUploads.length;return len?1:0},execute:function(selectedUploads){OSSAlert.confirm("确定要删除选择的碎片？").result.then(function(){angular.forEach(selectedUploads,function(upload){OSSApi.deleteUpload(Bucket.getCurrentBucket(),upload).success(function(){$rootScope.$broadcast("removeUpload",upload)}).error(function(res,status){$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)})})})}},{name:"detail",text:"详细",getState:function(selectedUploads){var len=selectedUploads.length;return!len||len>1?0:1},execute:function(selectedUploads){OSSModal.uploadDetail(Bucket.getCurrentBucket(),selectedUploads[0])}}];return{getAllMenu:function(){return allMenu}}}]).factory("OSSLocationHistory",["$location","$rootScope",function($location,$rootScope){var current,update=!0,history=[],maxLen=100;return $rootScope.$on("$locationChangeSuccess",function(){var url=$location.url(),l=history.length;update&&(current>=0&&l>current+1&&history.splice(current+1),history[history.length-1]!=url&&(history.push(url),history.length>maxLen&&history.splice(0,1)),current=history.length-1),update=!0}),{reset:function(){history=[],current=0,update=!0},go:function(isForward){(isForward&&this.canForward()||!isForward&&this.canBackward())&&(update=!1,$location.url(history[isForward?++current:--current]))},forward:function(){this.go(!0)},backward:function(){this.go()},canForward:function(){return current<history.length-1},canBackward:function(){return current>0}}}]).factory("OSSObject",["$location","$filter","OSSApi","$q","OSSLocation",function($location,$filter,OSSApi,$q,OSSLocation){var fileSorts={SORT_SPEC:["doc","docx","xls","xlsx","ppt","pptx","pdf","ai","cdr","psd","dmg","iso","md","ipa","apk"],SORT_MOVIE:["mp4","mkv","rm","rmvb","avi","3gp","flv","wmv","asf","mpeg","mpg","mov","ts","m4v"],SORT_MUSIC:["mp3","wma","wav","flac","ape","ogg","aac","m4a"],SORT_IMAGE:["jpg","png","jpeg","gif","psd","bmp","ai","cdr"],SORT_DOCUMENT:["doc","docx","xls","xlsx","ppt","pptx","pdf","odt","rtf","ods","csv","odp","txt"],SORT_CODE:["js","c","cpp","h","cs","vb","vbs","java","sql","ruby","php","asp","aspx","html","htm","py","jsp","pl","rb","m","css","go","xml","erl","lua","md"],SORT_ZIP:["rar","zip","7z","cab","tar","gz","iso"],SORT_EXE:["exe","bat","com"]},currentObject={};return{getCurrentObject:function(){return currentObject},setCurrentObject:function(object){currentObject=object},list:function(bucket,prefix,delimiter,lastLoadMaker,loadFileCount){var _self=this,defer=$q.defer();return OSSApi.getObjects(bucket,prefix,delimiter,lastLoadMaker,loadFileCount).success(function(res){var contents=res.ListBucketResult.Contents;contents=contents?angular.isArray(contents)?contents:[contents]:[];var commonPrefixes=res.ListBucketResult.CommonPrefixes;commonPrefixes=commonPrefixes?angular.isArray(commonPrefixes)?commonPrefixes:[commonPrefixes]:[];var files=[];angular.forEach($.merge(commonPrefixes,contents),function(file){file.Key!==prefix&&file.Prefix!==prefix&&files.push(_self.format(file))}),defer.resolve({files:files,marker:res.ListBucketResult.NextMarker,allLoaded:"false"===res.ListBucketResult.IsTruncated})}).error(function(res,status){defer.reject(res,status)}),defer.promise},format:function(object){var path=object.Key||object.Prefix,isDir="/"===Util.String.lastChar(path)?1:0,filename=isDir?$filter("getPrefixName")(path,1):$filter("baseName")(path);return{path:path,dir:isDir,filename:filename,lastModified:object.LastModified||"",size:object.Size?parseInt(object.Size):0,etag:object.ETag||""}},open:function(bucket,path,isDir){isDir&&$location.url(OSSLocation.getUrl(bucket.Name,path,"file"))},getIconSuffix:function(dir,filename){var suffix="",sorts=fileSorts;if(1==dir)suffix="folder";else{var ext=Util.String.getExt(filename);suffix=jQuery.inArray(ext,sorts.SORT_SPEC)>-1?ext:jQuery.inArray(ext,sorts.SORT_MOVIE)>-1?"video":jQuery.inArray(ext,sorts.SORT_MUSIC)>-1?"audio":jQuery.inArray(ext,sorts.SORT_IMAGE)>-1?"image":jQuery.inArray(ext,sorts.SORT_DOCUMENT)>-1?"document":jQuery.inArray(ext,sorts.SORT_ZIP)>-1?"compress":jQuery.inArray(ext,sorts.SORT_EXE)>-1?"execute":"other"}return suffix},getIcon:function(dir,name){return"icon-"+this.getIconSuffix(dir,name)}}}]).factory("OSSLocation",["$routeParams",function($routeParams){var OSSLocation={isCurrentBucket:function(bucketName){return bucketName==$routeParams.bucket},isCurrentObject:function(bucketName,objectPath){return objectPath&&"/"!=Util.String.lastChar(objectPath)&&(objectPath+="/"),OSSLocation.isCurrentBucket(bucketName)&&objectPath==($routeParams.object||"")},getUrl:function(bucketName,prefix,filter,searchParam){filter=angular.isUndefined(filter)?"file":filter,prefix=angular.isUndefined(prefix)?"":prefix;var url="";return url+="/"+filter,url+="/"+bucketName,prefix&&(url+="/"+encodeURIComponent(prefix)),searchParam&&(url+="?"+$.param(searchParam)),url}};return OSSLocation}]).factory("Bread",["OSSLocation",function(OSSLocation){var getFilterName=function(filter){var filterName="";switch(filter){case"upload":filterName="碎片管理"}return filterName};return{getBreads:function(bucketName,path,filter){var breads=[];if(breads.push({name:bucketName,url:OSSLocation.getUrl(bucketName)}),"file"!==filter&&breads.push({name:getFilterName(filter),url:OSSLocation.getUrl(bucketName,"",filter)}),path&&path.length){path=Util.String.rtrim(Util.String.ltrim(path,"/"),"/");for(var paths=path.split("/"),i=0;i<paths.length;i++){for(var bread={name:paths[i]},fullpath="",j=0;i>=j;j++)fullpath+=paths[j]+"/";bread.url=OSSLocation.getUrl(bucketName,fullpath),breads.push(bread)}}return breads}}}]).factory("RequestXML",function(){return{getXMLHeader:function(){return'<?xml version="1.0" encoding="UTF-8"?>'},getCreateBucketXML:function(region){return region=region.replace("-internal",""),[this.getXMLHeader(),"<CreateBucketConfiguration >","<LocationConstraint >",region,"</LocationConstraint >","</CreateBucketConfiguration >"].join("")},getSetBucketReferXML:function(refer){for(var referers=refer.content.split(";"),_referContent="",i=0;i<referers.length;i++)_referContent+="<Referer>"+referers[i]+"</Referer>";return[this.getXMLHeader(),"<RefererConfiguration>","<AllowEmptyReferer>",refer.allowEmpty,"</AllowEmptyReferer>","<RefererList>",_referContent,"</RefererList>","</RefererConfiguration>"].join("")}}}).factory("Bucket",["OSSApi","$q","OSSException","$rootScope","OSSRegion",function(OSSApi,$q,OSSException,$rootScope,OSSRegion){var listPromise,buckets=null,deferred=$q.defer();return{list:function(){return listPromise?listPromise:(OSSApi.getBuckets().success(function(res){$rootScope.$broadcast("bucketsLoaded");var resBuckets=res.ListAllMyBucketsResult.Buckets.Bucket;buckets=resBuckets?angular.isArray(resBuckets)?resBuckets:[resBuckets]:[],angular.forEach(buckets,function(bucket){var region=OSSRegion.getRegionByLocation(bucket.Location);region&&(bucket.Location=region.location.replace("-internal",""))}),deferred.resolve(buckets)}).error(function(res,status){$rootScope.$broadcast("bucketsLoaded"),$rootScope.$broadcast("showError",OSSException.getError(res,status).msg),deferred.reject(res,status)}),listPromise=deferred.promise)},getAcls:function(){return{"public-read":"公共读","public-read-write":"公共读写","private":"私有"}},getBucket:function(buckeName){return _.findWhere(buckets,{Name:buckeName})},select:function(bucket){bucket.selected=!0},unselected:function(bucket){bucket.selected=!1},getCurrentBucket:function(){return _.findWhere(buckets,{selected:!0})}}}]).factory("OSSApi",["$http","RequestXML","OSSConfig","OSSRegion",function($http,RequestXML,OSSConfig,OSSRegion){var OSSAccessKeyId=OSS.invoke("getAccessID"),currentLocation=OSS.invoke("getCurrentLocation"),host=OSSConfig.getHost(),getExpires=function(expires){return expires=angular.isUndefined(expires)?30:expires,parseInt((new Date).getTime()/1e3)+expires},getRequestUrl=function(bucket,region,expires,signature,canonicalizedResource,extraParam){region=OSSRegion.changeLocation(region);var requestUrl="http://"+(bucket?bucket+".":"")+(region?region+".":"")+host;return canonicalizedResource=canonicalizedResource.replace(new RegExp("^/"+bucket),""),requestUrl+=canonicalizedResource,requestUrl+=(requestUrl.indexOf("?")>=0?"&":"?")+$.param({OSSAccessKeyId:OSSAccessKeyId,Expires:expires,Signature:signature}),requestUrl+=extraParam?"&"+$.param(extraParam):""},getCanonicalizedResource=function(bucketName,objectName,subResources){var subResourcesStr=subResources?Util.param(subResources):"";return"/"+(bucketName?bucketName+"/":"")+(objectName?objectName:"")+(subResourcesStr?"?"+subResourcesStr:"")};return{getURI:function(bucket,objectName,expires){if(expires){expires=getExpires(expires);var canonicalizedResource=getCanonicalizedResource(bucket.Name,objectName),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource});return getRequestUrl(bucket.Name,bucket.Location,expires,signature,getCanonicalizedResource(bucket.Name,encodeURIComponent(objectName)))}var _location=OSSRegion.changeLocation(bucket.Location);return"http://"+bucket.Name+"."+_location+"."+host+"/"+encodeURIComponent(objectName)},getBuckets:function(){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl("",currentLocation?currentLocation:"oss",expires,signature,canonicalizedResource);return $http.get(requestUrl)},getBucketRefer:function(bucket){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,"",{referer:void 0}),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource);return $http.get(requestUrl)},setBucketRefer:function(bucket,refer){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,"",{referer:void 0}),contentType="application/xml",signature=OSS.invoke("getSignature",{verb:"PUT",content_type:contentType,expires:expires,canonicalized_resource:canonicalizedResource}),headers=angular.extend({},{},{Accept:contentType,"Content-Type":contentType}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource);return $http.put(requestUrl,RequestXML.getSetBucketReferXML(refer),{headers:headers})},createBucket:function(bucketName,region,acl){var expires=getExpires(),canonicalizedOSSheaders={"x-oss-acl":acl},canonicalizedResource=getCanonicalizedResource(bucketName),contentType="application/xml",signature=OSS.invoke("getSignature",{verb:"PUT",content_type:contentType,expires:expires,canonicalized_oss_headers:canonicalizedOSSheaders,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucketName,region,expires,signature,canonicalizedResource),headers=angular.extend({},canonicalizedOSSheaders,{"Content-Type":contentType});return $http.put(requestUrl,RequestXML.getCreateBucketXML(region),{headers:headers})},getBucketAcl:function(bucket){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,"",{acl:void 0}),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource);return $http.get(requestUrl)},editBucket:function(bucket,acl){var expires=getExpires(),canonicalizedOSSheaders={"x-oss-acl":acl},canonicalizedResource=getCanonicalizedResource(bucket.Name,""),contentType="application/xml",signature=OSS.invoke("getSignature",{verb:"PUT",content_type:contentType,expires:expires,canonicalized_oss_headers:canonicalizedOSSheaders,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource),headers=angular.extend({},canonicalizedOSSheaders,{"Content-Type":contentType});return $http.put(requestUrl,"",{headers:headers})},delBucket:function(bucket){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,""),signature=OSS.invoke("getSignature",{verb:"DELETE",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource);return $http.delete(requestUrl)},getObjects:function(bucket,prefix,delimiter,marker,maxKeys){var param={prefix:prefix};$.extend(param,{delimiter:delimiter,marker:marker,"max-keys":maxKeys});var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,""),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource,param);return $http.get(requestUrl)},getObjectMeta:function(bucket,object){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,object),signature=OSS.invoke("getSignature",{verb:"HEAD",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,getCanonicalizedResource(bucket.Name,encodeURIComponent(object)));return $http.head(requestUrl)},putObject:function(bucket,objectPath,headers,canonicalizedOSSheaders){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,objectPath),signature=OSS.invoke("getSignature",{verb:"PUT",content_type:headers["Content-Type"],expires:expires,canonicalized_oss_headers:canonicalizedOSSheaders,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,getCanonicalizedResource(bucket.Name,encodeURIComponent(objectPath)));return $http.put(requestUrl,"",{headers:angular.extend({},headers,canonicalizedOSSheaders)})},listUploads:function(bucket,prefix,delimiter,keyMarker,maxUploads,uploadIdMaker){var param={prefix:prefix};$.extend(param,{delimiter:delimiter,"key-marker":keyMarker,"upload-id-marker":uploadIdMaker,"max-uploads":maxUploads});var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,"",{uploads:void 0}),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,canonicalizedResource,param);return $http.get(requestUrl)},deleteUpload:function(bucket,upload){var expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,upload.path,{uploadId:upload.id}),signature=OSS.invoke("getSignature",{verb:"DELETE",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,getCanonicalizedResource(bucket.Name,encodeURIComponent(upload.path),{uploadId:upload.id}));return $http.delete(requestUrl)},listUploadPart:function(bucket,upload,partNumberMaker,maxParts){var param={"part-number-marker":partNumberMaker,"max-parts":maxParts},expires=getExpires(),canonicalizedResource=getCanonicalizedResource(bucket.Name,upload.path,{uploadId:upload.id}),signature=OSS.invoke("getSignature",{verb:"GET",expires:expires,canonicalized_resource:canonicalizedResource}),requestUrl=getRequestUrl(bucket.Name,bucket.Location,expires,signature,getCanonicalizedResource(bucket.Name,encodeURIComponent(upload.path),{uploadId:upload.id}),param);
return $http.get(requestUrl)}}}]).factory("OSSUploadPart",["OSSApi","$filter","$q",function(OSSApi,$filter,$q){return{list:function(bucket,prefix,delimiter,lastKeyMaker,loadFileCount,lastUploadMaker){var _self=this,defer=$q.defer();return OSSApi.listUploads(bucket,prefix,delimiter,lastKeyMaker,loadFileCount,lastUploadMaker).success(function(res){var result=res.ListMultipartUploadsResult,contents=result.Upload;contents=contents?angular.isArray(contents)?contents:[contents]:[];var commonPrefixes=result.CommonPrefixes;commonPrefixes=commonPrefixes?angular.isArray(commonPrefixes)?commonPrefixes:[commonPrefixes]:[];var files=[];angular.forEach($.merge(contents,commonPrefixes),function(file){file.Key!==prefix&&file.Prefix!==prefix&&files.push(_self.format(file))}),defer.resolve({uploads:files,keyMaker:result.NextKeyMarker,uploadIdMaker:result.NextUploadIdMarker,allLoaded:"false"===result.IsTruncated})}).error(function(res,status){defer.reject(res,status)}),defer.promise},format:function(upload){var path=upload.Key||upload.Prefix,isDir="/"===Util.String.lastChar(path)?1:0,filename=isDir?$filter("getPrefixName")(path,1):$filter("baseName")(path);return{path:path,dir:isDir,filename:filename,id:upload.UploadId,initTime:upload.Initiated}}}}]).factory("OSSModal",["$modal","OSSAlert","OSSDialog","OSSConfig","Bucket","OSSApi","OSSObject","OSSException","OSSRegion","$rootScope","usSpinnerService",function($modal,OSSAlert,OSSDialog,OSSConfig,Bucket,OSSApi,OSSObject,OSSException,OSSRegion,$rootScope,usSpinnerService){var defaultOption={backdrop:"static"};return{setting:function(){var option={templateUrl:"views/setting_modal.html",windowClass:"setting_modal",controller:function($scope,$modalInstance){$scope.min=1,$scope.max=10,$scope.maxTaskLimit=99,$scope.isCustomClient=OSSConfig.isCustomClient(),$scope.setting=OSS.invoke("getTransInfo");var checkSetting=function(setting){var unValidMsg="";return angular.forEach(setting,function(val,key){return/^[1-9]{1}[0-9]*$/.test(val)?void 0:(unValidMsg="设置的值必须是正整数",unValidMsg=_.indexOf(["upload_peer_max","download_peer_max"],key)>=0?"单任务线程数必须是大于"+$scope.min+"小于等于"+$scope.max+"的整数":"同时任务数必须是大于"+$scope.min+"小于等于"+$scope.maxTaskLimit+"的整数",!1)}),unValidMsg?($rootScope.$broadcast("showError",unValidMsg),!1):!0};$scope.saveSetting=function(setting){checkSetting(setting)&&(OSS.invoke("setTransInfo",setting),$modalInstance.dismiss("cancel"))},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.exportAuth=function(){OSSDialog.exportAuthorization()}}};return option=angular.extend({},defaultOption,option),$modal.open(option)},addBucket:function(bucket){var _context=this,option={templateUrl:"views/add_bucket_modal.html",windowClass:"add_bucket_modal",controller:function($scope,$modalInstance){$scope.loading=!1,$scope.getingBucketInfo=!1,$scope.bucket=bucket||null,$scope.cBucket={};var acls=[];if(angular.forEach(Bucket.getAcls(),function(val,key){acls.push({name:val,value:key})}),$scope.acls=acls,bucket||($scope.acls.selected=$scope.acls[0]),$scope.$watch("loading",function(newVal){newVal?usSpinnerService.spin("add-bucket-spinner"):usSpinnerService.stop("add-bucket-spinner")}),$scope.$watch("getingBucketInfo",function(newVal){newVal?usSpinnerService.spin("get-bucket-spinner"):usSpinnerService.stop("get-bucket-spinner")}),$scope.isDisableLocationSelect=OSSConfig.isDisableLocationSelect(),$scope.isDisableLocationSelect||($scope.regions=OSSRegion.list()),bucket)$scope.cBucket.region=OSSRegion.getRegionByLocation(bucket.Location);else if($scope.isDisableLocationSelect){var currentLocation=OSS.invoke("getCurrentLocation");if(!currentLocation)return;$scope.cBucket.region=OSSRegion.getRegionByLocation(currentLocation)}else $scope.cBucket.region=$scope.regions[0];$scope.bucket?($scope.loading=!0,$scope.getingBucketInfo=!0,OSSApi.getBucketAcl(bucket).success(function(res){$scope.loading=!1,$scope.getingBucketInfo=!1,$scope.acls.selected=Util.Array.getObjectByKeyValue($scope.acls,"value",res.AccessControlPolicy.AccessControlList.Grant)}).error(function(res,status){$scope.loading=!1,$scope.getingBucketInfo=!1,$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)})):$scope.loading=!0,$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.loading=!1,$scope.createBucket=function(bucketName,region,acl){return bucketName&&bucketName.length?/^[a-z0-9][a-z0-9\-]{1,61}[a-z0-9]$/.test(bucketName)?Bucket.getBucket(bucketName)?void $rootScope.$broadcast("showError","已存在相同名称的Bucket"):($scope.loading=!0,void OSSApi.createBucket(bucketName,region.location,acl.value).success(function(){$scope.loading=!1,$modalInstance.close({act:"add",bucket:{Name:bucketName,Location:region.location,Acl:acl.value}})}).error(function(response,statusCode){$scope.loading=!1,$rootScope.$broadcast("showError",OSSException.getError(response,statusCode).msg)})):void $rootScope.$broadcast("showError","Bucket的名称格式错误"):void $rootScope.$broadcast("showError","Bucket的名称不能为空")},$scope.editBucket=function(acl){$scope.loading=!0,OSSApi.editBucket(bucket,acl.value).success(function(){$scope.loading=!1,angular.extend(bucket,{Acl:acl.value}),$modalInstance.close({act:"edit",bucket:bucket})}).error(function(response,statusCode){$scope.loading=!1,$rootScope.$broadcast("showError",OSSException.getError(response,statusCode).msg)})},$scope.delBucket=function(){_context.delBucketConfirm(bucket).result.then(function(param){OSS.invoke("deleteBucket",{keyid:param.accessKey,keysecret:param.accessSecret,bucket:bucket.Name,location:bucket.Location},function(res){res.error?alert(OSSException.getClientErrorMsg(res)):($rootScope.$broadcast("removeBucket",bucket),$rootScope.$broadcast("reloadUploadQueue"),$rootScope.$broadcast("reloadDownloadQueue"),$modalInstance.close())})})}}};return option=angular.extend({},defaultOption,option),$modal.open(option)},setObjectHttpHeader:function(bucket,object){var option={templateUrl:"views/set_http_header_modal.html",windowClass:"set_http_header_modal",controller:function($scope,$modalInstance){$scope.object=object,$scope.headers=[],angular.forEach("Content-Type Content-Disposition Content-Language Cache-Control Expires".split(" "),function(val){$scope.headers.push({name:val,text:val})}),$scope.customHeaders=[{nameModel:"",contentModel:""}],$scope.$watch("saving",function(newVal){newVal?usSpinnerService.spin("set-http-spinner"):usSpinnerService.stop("set-http-spinner")}),$scope.$watch("loading",function(newVal){newVal?usSpinnerService.spin("loading-spinner"):usSpinnerService.stop("loading-spinner")}),$scope.loading=!0,OSSApi.getObjectMeta(bucket,object.path).success(function(data,status,getHeader){$scope.loading=!1,angular.forEach($scope.headers,function(header){header.model=getHeader(header.name)}),angular.forEach(getHeader(),function(val,key){0===key.indexOf("x-oss-meta-")&&$scope.customHeaders.push({nameModel:key.replace(/^x-oss-meta-/,""),contentModel:val})})}).error(function(res,status){$scope.loading=!1,$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)}),$scope.setHttpHeader=function(headers,customHeaders){var ossHeaders={},canonicalizedOSSheaders={},unValidFieldValue=!1,checkFieldValueIsValid=function(value){return/^[a-zA-Z0-9\-_/.;,:]+$/.test(value)};angular.forEach(headers,function(val){if(val.model){if(!checkFieldValueIsValid(val.model))return unValidFieldValue=!0,!1;ossHeaders[val.name]=val.model}});var unValidField=!1;if(angular.forEach(customHeaders,function(val){if(val.nameModel){if(!/^[a-zA-Z0-9\-]+$/.test(val.nameModel))return unValidField=!0,!1;if(val.contentModel){if(!checkFieldValueIsValid(val.contentModel))return unValidFieldValue=!0,!1;canonicalizedOSSheaders["x-oss-meta-"+val.nameModel.toLowerCase()]=val.contentModel||""}}}),unValidFieldValue){var msg="HTTP属性值格式错误";return msg+='<p class="text-muted">属性名称只能包含英文、数子、横线、下划线、斜杠、点、英文分号、英文逗号、英文冒号</p>',void $rootScope.$broadcast("showError",msg)}if(unValidField){var msg="属性名称格式错误";return msg+='<p class="text-muted">属性名称只能包含英文、数子或横线</p>',void $rootScope.$broadcast("showError",msg)}$scope.saving=!0,angular.extend(canonicalizedOSSheaders,{"x-oss-copy-source":"/"+bucket.Name+"/"+encodeURIComponent(object.path)}),OSSApi.putObject(bucket,object.path,ossHeaders,canonicalizedOSSheaders).success(function(){$scope.saving=!1,$modalInstance.close()}).error(function(res,status){$scope.saving=!1,$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)})},$scope.addCustomHeader=function(){$scope.customHeaders.push({nameModel:"",contentModel:""})},$scope.removeCustomHeader=function(header){var index=_.indexOf($scope.customHeaders,header);index>-1&&$scope.customHeaders.splice(index,1)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};return option=angular.extend({},defaultOption,option),$modal.open(option)},setRefer:function(bucket){var option={templateUrl:"views/set_refer_modal.html",windowClass:"set_refer_modal",controller:function($scope,$modalInstance){$scope.loading=!0,$scope.refer={content:"",allowEmpty:!0},OSSApi.getBucketRefer(bucket).success(function(res){$scope.loading=!1;var _referContent="";if(res.RefererConfiguration&&res.RefererConfiguration.RefererList&&res.RefererConfiguration.RefererList.Referer)if(angular.isArray(res.RefererConfiguration.RefererList.Referer))for(var i=0;i<res.RefererConfiguration.RefererList.Referer.length;i++)_referContent+=res.RefererConfiguration.RefererList.Referer[i]+";";else _referContent+=res.RefererConfiguration.RefererList.Referer+";";$scope.refer.content=_referContent.replace(/;/g,"\r"),$scope.refer.allowEmpty=Boolean("true"==res.RefererConfiguration.AllowEmptyReferer)}).error(function(res,status){$scope.loading=!1,$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)}),$scope.disabledSave=function(){return $scope.refer.allowEmpty||$scope.refer.content&&0!=$scope.refer.content.length?$scope.saving?!0:!1:!0},$scope.setReferer=function(){$scope.saving=!0;var _refer=$scope.refer.content.replace(/\r|\n/gi,";"),params={content:_refer,allowEmpty:$scope.refer.allowEmpty};OSSApi.setBucketRefer(bucket,params).success(function(){$scope.saving=!1,$modalInstance.dismiss("cancel")}).error(function(res,status){$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};return option=angular.extend({},defaultOption,option),$modal.open(option)},getObjectURI:function(bucket,object){var option={templateUrl:"views/get_object_uri_modal.html",windowClass:"get_object_uri_modal",controller:function($scope,$modalInstance){$scope.filename=Util.String.baseName(object.path),$scope.expire=3600,$scope.loading=!0,$scope.$watch("loading",function(newVal){newVal?usSpinnerService.spin("get-acl-spinner"):usSpinnerService.stop("get-acl-spinner")}),OSSApi.getBucketAcl(bucket).success(function(res){if($scope.loading=!1,res&&res.AccessControlPolicy&&res.AccessControlPolicy.AccessControlList&&res.AccessControlPolicy.AccessControlList.Grant){var acl=res.AccessControlPolicy.AccessControlList.Grant;"private"!=acl&&($scope.uri=OSSApi.getURI(bucket,object.path))}}).error(function(res,status){$scope.loading=!1,$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)}),$scope.getUri=function(expire){$scope.uri=OSSApi.getURI(bucket,object.path,expire)},$scope.copyToClipborad=function(uri){OSS.invoke("setClipboardData",uri),alert("已复制到剪切板")},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};return option=angular.extend({},defaultOption,option),$modal.open(option)},uploadDetail:function(bucket,upload){var option={templateUrl:"views/upload_detail_modal.html",windowClass:"upload_detail_modal",controller:function($scope,$modalInstance){$scope.loading=!1,$scope.parts=[];var size=50,lastMaker="",allLoaded=!1,loadPart=function(){$scope.loading||($scope.loading=!0,$scope.firstLoading=!0,OSSApi.listUploadPart(bucket,upload,lastMaker,size).success(function(res){$scope.loading=!1,$scope.parts&&$scope.parts.length||($scope.firstLoading=!1);var result=res.ListPartsResult;lastMaker=result.NextPartNumberMarker,allLoaded="false"===result.IsTruncated;var parts=[];result.Part&&(parts=angular.isArray(result.Part)?result.Part:[result.Part]),$scope.parts=$scope.parts.concat(parts)}).error(function(res,status){$scope.loading=!1,$rootScope.$broadcast("showError",OSSException.getError(res,status).msg)}))};loadPart(),$scope.$watch("firstLoading",function(newVal){newVal?usSpinnerService.spin("load-upload-detail-spinner"):usSpinnerService.stop("load-upload-detail-spinner")}),$scope.loadMore=function(){allLoaded||loadPart()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}};return option=angular.extend({},defaultOption,option),$modal.open(option)},delBucketConfirm:function(bucket){var option={templateUrl:"views/del_bucket_confirm_modal.html",windowClass:"del_bucket_confirm_modal",controller:function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.delConfirm=function(accessKey,accessSecret){return accessKey?accessSecret?void OSSAlert.confirm("确定要删除Bucket “"+bucket.Name+"“吗？删除后数据将无法恢复").result.then(function(){$modalInstance.close({accessKey:accessKey,accessSecret:accessSecret})}):void $rootScope.$broadcast("showError","请输入 Access Key Secret"):void $rootScope.$broadcast("showError","请输入 Access Key ID")}}};return option=angular.extend({},defaultOption,option),$modal.open(option)}}}]),angular.module("ossClientUiApp").filter("bitSize",function(){return Util.Number.bitSize}).filter("formatTime",["$filter",function($filter){return function(dateStr){return $filter("date")(Date.parse(dateStr),"yyyy-MM-dd HH:mm:ss")}}]).filter("getPrefixName",function(){return function(prefix,removeLastSlash){removeLastSlash=angular.isUndefined(removeLastSlash)?0:removeLastSlash;var arr=prefix.split("/");return arr[arr.length-2]+(removeLastSlash?"":"/")}}).filter("getRemainTime",function(){return function(speed,filesize,offset){if(!speed)return"--:--:--";var second=(filesize-offset)/speed;if(0>second)return second=0,"--:--:--";var d=parseInt(second/3600/24),h=parseInt(second/3600%24),m=parseInt(second/60%24),s=parseInt(second%60);return d>0?"大于"+d+"天":(10>h&&(h="0"+h),10>m&&(m="0"+m),10>s&&(s="0"+s),h+":"+m+":"+s)}}).filter("getQueueState",function($filter){return function(type,status,speed,filesize,offset,errormsg){var state="";switch(status){case 1:state=$filter("getRemainTime")(speed,filesize,offset);break;case 2:state="等待"+("upload"==type?"上传":"下载");break;case 3:state="暂停";break;case 4:state="完成";break;case 5:state="错误："+errormsg}return state}}).filter("getLocation",["OSSLocation",function(OSSLocation){return OSSLocation.getUrl}]).filter("baseName",function(){return Util.String.baseName}),angular.module("ossClientUiApp").directive("createFile",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var createFileItem,fn=$parse(attrs.createFileCallback);scope.$watch(attrs.createFile,function(value){if(value){element.scrollTop(0);var defaultFilename="新建文件夹",$input=angular.element('<input name="folder-name" class="form-control" value="'+defaultFilename+'" />'),$okBtn=angular.element('<button class="btn btn-primary">确定</button>'),$cancelBtn=angular.element('<button class="btn btn-default">取消</button>');createFileItem=angular.element('<div class="clearfix file-item new-file-item"><div class="pull-left filename"><i class="file-icon-32 icon-folder"></i></div></div>'),createFileItem.find(".filename").append($input).append($okBtn).append($cancelBtn),createFileItem.prependTo(element),$input[0].select(),$input[0].selectionStart=0,$input[0].selectionEnd=defaultFilename.length,$input.focus(),$okBtn.click(function(){scope.$apply(function(){var filename=$.trim($input.val());createFileItem.find("button").prop("disabled",!0),$.isFunction(fn)&&fn(scope,{filename:filename,callback:function(success){success?scope[attrs.createFile]=!1:createFileItem.find("button").prop("disabled",!1)}})})}),$cancelBtn.click(function(){scope.$apply(function(){scope[attrs.createFile]=!1})}),$input.on("keydown",function(event){13==event.keyCode&&$okBtn.trigger("click")})}else createFileItem&&createFileItem.remove()})}}}]).directive("smartSearch",["$location","$rootScope","$filter","OSSObject","Bucket","OSSLocation",function($location,$rootScope,$filter,OSSObject,Bucket,OSSLocation){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var bread=element.parent().next();element.on("keydown",function(e){var keycode=e.keyCode;if(13==keycode){var keyword=ngModel.$modelValue;if(keyword){var currentObj=OSSObject.getCurrentObject(),currentBucket=Bucket.getCurrentBucket();scope.$apply(function(){var url=OSSLocation.getUrl(currentBucket.Name,currentObj.path,"file",{keyword:keyword,scope:""});$location.url(url)})}}});var $breadList=bread.find(".bread-list"),$searchWrapper=element.parent(),hideSearch=function(){$searchWrapper.find(".search-scope").remove(),$searchWrapper.find(".fa-remove").remove(),$breadList.show(),element.next(".fa").show(),scope[attrs.ngModel]="";var search=$location.search();search.keyword&&$location.url($location.path())},showSearch=function(){if(!element.next(".search-scope").size()){var currentObj=OSSObject.getCurrentObject(),currentBucket=Bucket.getCurrentBucket(),searchScopeName=currentObj.path?$filter("getPrefixName")(currentObj.path,1):currentBucket.Name,$removeIcon=$('<a href="javascript:;" class="fa fa-remove fa-lg"></a>'),$searchScope=$('<div class="search-scope"> 在 <span>'+searchScopeName+"</span> 中搜索</div>");element.next(".fa").hide(),element.after($searchScope).after($removeIcon),element.css({"padding-left":$searchScope.outerWidth(!0)+6}),$breadList.hide(),$removeIcon.on("click",function(){scope.$apply(function(){hideSearch()})}),element.focus()}};element.on("mousedown",function(){showSearch()}),element.next(".fa").on("click",function(){showSearch()}),scope.$on("$locationChangeSuccess",function(){var param=$location.search();param&&param.keyword||hideSearch()})}}}]).directive("smartBread",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element){var offsetParent=element.offsetParent(),lastMaxWidth=0;lastMaxWidth=element.css("maxWidth").indexOf("%")>=0?offsetParent.width()*(parseFloat(element.css("maxWidth"))/100):parseInt(element.css("maxWidth"));var getBreadItemWidth=function(breadItem){return breadItem.outerWidth(!0)},getTotalBreadWidth=function(breads){var totalWidth=0;return breads.each(function(){totalWidth+=getBreadItemWidth($(this))}),totalWidth},setBreadUI=function(){var totalWidth=(element.width(),getTotalBreadWidth(element.find(".bread-item")));totalWidth>lastMaxWidth&&totalWidth>lastMaxWidth&&scope.breads.shift()};scope.$watch("breads",function(val){val&&val.length&&$timeout(function(){setBreadUI()})}),$(window).on("resize",function(){lastMaxWidth=offsetParent().width()*maxWidthSet})}}}]).directive("queueItem",["OSSQueueItem",function(OSSQueueItem){return{templateUrl:"views/queue-item.html",restrict:"E",replace:!0,scope:{type:"@",item:"=data",executeCmd:"&"},link:function(scope){scope.handleCmdClick=function(cmd,item){scope.executeCmd({cmd:cmd,item:item})},scope.isError=OSSQueueItem.isError,scope.isInProgress=OSSQueueItem.isInProgress,scope.isDone=OSSQueueItem.isDone,scope.isWaiting=OSSQueueItem.isWaiting,scope.isPasued=OSSQueueItem.isPaused,scope.getProgress=function(item){return scope.isError(item)||scope.isPasued(item)||scope.isWaiting(item)||scope.isInProgress(item)?0==item.filesize?100:item.offset/item.filesize*100:100}}}}]).directive("menu",[function(){return{template:'<button class="btn btn-default" ng-class="menu-{{name}}" ng-disabled="state==0" ng-show="state>-1" ng-transclude></button>',restrict:"E",replace:!0,transclude:!0,scope:{text:"@",name:"@",state:"=",shortcut:"@",execute:"&"},link:function(scope,element){element.click(function(event){scope.execute({$event:event})})}}}]).directive("onlyNumber",["$timeout",function($timeout){return{restrict:"A",replace:!1,link:function(scope,element,attrs){var _val=0;$timeout(function(){var min=parseInt(attrs.min),max=parseInt(attrs.max);_val=element.val(),element.keydown(function(event){return event.ctrlKey||event.shiftKey?!1:event.keyCode>47&&event.keyCode<58||event.keyCode>95&&event.keyCode<106||"37 38 39 40 8".indexOf(event.keyCode+"")>=0?!0:!1}).keyup(function(){!min&&0!=min||!max&&0!=max||(_val=element.val(),!_val||min>_val?(element.val(min),_val=min):_val>max&&(element.val(max),_val=max))})})}}}]).directive("fileIcon",["OSSObject",function(OSSObject){return{template:'<i class="file-icon-{{size}} {{icon}}"></i>',restrict:"E",replace:!0,scope:{dir:"@",filename:"@",size:"@"},link:function(scope){scope.icon=OSSObject.getIcon(scope.dir,scope.filename)}}}]).directive("keyboardNav",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var list=[],enableKeyboardNav=!1,shiftLastIndex=0,keyboardNavStep=1;scope.$watch(attrs.keyboardNavList,function(newVal){shiftLastIndex=0,list=newVal}),attrs.$observe("keyboardNav",function(newVal){enableKeyboardNav=1==newVal?!0:!1}),attrs.$observe("keyboardNavStep",function(newVal){keyboardNavStep=parseInt(newVal)});var getSelectedList=$parse(attrs.getSelectedList),getSelectedMinIndex=function(){return _.indexOf(list,_.findWhere(list,{selected:!0}))},getSelectedMaxIndex=function(){var selectedFiles=getSelectedList(scope);return selectedFiles&&selectedFiles.length?_.indexOf(list,selectedFiles[selectedFiles.length-1]):-1},select=$parse(attrs.select),unSelect=$parse(attrs.unSelect),unSelectAll=function(){angular.forEach(getSelectedList(scope),function(item){unSelect(scope,{item:item})})},upLeftPress=function($event){var step=keyboardNavStep,initIndex=list.length+step-1,selectedIndex=getSelectedMinIndex();selectedIndex>=0&&(initIndex=selectedIndex);var newIndex=initIndex-step;if(0>newIndex&&(newIndex=0),$event.shiftKey)for(var i=initIndex>list.length-1?list.length-1:initIndex;i>=newIndex;i--)select(scope,{item:list[i]});else unSelectAll(),select(scope,{item:list[newIndex]}),shiftLastIndex=newIndex},downRightPress=function($event){var step=keyboardNavStep,initIndex=-1*step,selectedIndex=getSelectedMaxIndex();selectedIndex>=0&&(initIndex=selectedIndex);var newIndex=initIndex+step;if(newIndex>list.length-1&&(newIndex=list.length-1),$event.shiftKey)for(var i=initIndex>0?initIndex:0;newIndex>=i;i++)select(scope,{item:list[i]});else unSelectAll(),select(scope,{item:list[newIndex]}),shiftLastIndex=newIndex};$(document).on("keydown.keyboardNav",function($event){enableKeyboardNav&&(["INPUT","TEXTAREA"].indexOf($event.target.nodeName)>=0||(scope.$apply(function(){switch($event.keyCode){case 37:case 38:upLeftPress($event);break;case 39:case 40:downRightPress($event)}}),$event.preventDefault()))}),scope.$on("$destroy",function(){$(document).off("keydown.keyboardNav")})}}}]);