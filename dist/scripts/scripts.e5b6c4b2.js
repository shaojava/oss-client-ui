"use strict";!function(a){function b(){var a=navigator.userAgent.split(";")[0]||"";return"gk_sync"==a.toLowerCase()}function c(a){var b={},c="";for(var d in a)0===d.toLowerCase().indexOf("x-oss-",0)&&(b[d.toLowerCase()]=a[d]);if(b!={}){var e=[];for(var d in b)e.push(d);e.sort();for(var d in e)c+=e[d]+":"+b[e[d]]+"\n"}return c}var d="aNgmvBucXXcJnOgj",e="GBJN7GarVWrITZT9YZR64Ir6bOLEM5",f={getAccessID:function(){return d},getSignature:function(a){var b=JSON.parse(a),d=[b.verb,b.content_md5,b.content_type,b.expires],f="";b.canonicalized_oss_headers&&(f=c(b.canonicalized_oss_headers));var g=b.canonicalized_resource;return CryptoJS.enc.Base64.stringify(CryptoJS.HmacSHA1(d.join("\n")+"\n"+f+g,e))}};b()||(a.OSSClient=f)}(window),window.debug=!0;var OSS={invoke:function(a,b,c){if("undefined"==typeof OSSClient)throw new Error("Can not find OSSClient");if("function"!=typeof OSSClient[a])throw new Error("Can not find interface "+a);var d=[JSON.stringify(b)];"function"==typeof c&&d.push(function(b){b=JSON.parse(b),this.log(a+":callback",b),c(b)}),this.log(a,d);var e=OSSClient[a].apply(this,d);return this.log(a+":return",e),e},log:function(a,b){window.debug&&console.log(a,b)},getUserAgent:function(){return navigator.userAgent.split(";")},getClientOS:function(){var a=this.getUserAgent()[2]||"";return a.toLowerCase()},isWindowsClient:function(){return"windows"==this.getClientOS()},isMacClient:function(){return"mac"==this.getClientOS()},isClientOS:function(){return this.isWindowsClient()||this.isMacClient()},isOSSClient:function(){var a=this.getUserAgent()[0]||"";return"gk_sync"==a.toLowerCase()}};angular.module("OSSCommon",[]).directive("scrollLoad",["$rootScope","$parse",function(a,b){return{restrict:"A",link:function(a,c,d){var e=0,f=!1;null!=d.triggerDistance&&a.$watch(d.triggerDistance,function(a){return e=parseInt(a||0,10)}),null!=d.disableScroll&&a.$watch(d.disableScroll,function(a){return f=!!a});var g="down";d.triggerDirection&&(g=d.triggerDirection);var h=0,i=b(d.scrollLoad);c.on("scroll.scrollLoad",function(b){var d=jQuery(this),j=0,k=0,l=0,m=!1;k=jQuery.isWindow(this)?document.body.scrollHeight:c[0].scrollHeight,l=d.scrollTop(),m=l>h;var n=jQuery.isWindow(this)?document.documentElement.clientHeight||document.body.clientHeight:this.clientHeight;j="down"==g?k-l-n:l,e>=j&&!f&&(!m&&"up"==g||m&&"down"==g)&&a.$apply(function(){i(a,{$event:b})}),h=l}),a.$on("$destroy",function(){c.off("scroll.scrollLoad")})}}}]),angular.module("ossClientUiApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angularSpinner","OSSCommon"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/file/:bucket?/:object*?",{templateUrl:"views/filelist.html",controller:"FileListCtrl",resolve:{buckets:function(a){return a.list()}}}).otherwise({redirectTo:"/file/"}),b.defaults.transformResponse.unshift(function(a,b){return"application/xml"==b("content-type")?$.xml2json(a):a})}]),angular.module("ossClientUiApp").run(["$rootScope",function(a){a.PAGE_CONFIG={}}]).controller("MainCtrl",["$scope","OSSApi","OSSModal","Bucket","Bread","OSSLocationHistory","OSSMenu","$rootScope",function(a,b,c,d,e,f,g,h){a.buckets=[],d.list().then(function(b){a.buckets=angular.isArray(b)?b:[b]}),a.showAddBucketModal=function(){c.addBucket().result.then(function(b){"add"==b.act&&a.buckets.push(b.bucket)})},a.editBucket=function(b){c.addBucket(b).result.then(function(b){"del"==b.act&&Util.Array.removeByValue(a.buckets,b.bucket)})},a.breads=[],a.$watchCollection("[PAGE_CONFIG.bucket,PAGE_CONFIG.objectPrefix]",function(b){if(b[0]){var c=b[0],d=b[1];a.breads=e.getBreads(c.Name,d),a.historyCanForward=f.canForward(),a.historyCanBackward=f.canBackward(),a.topMenuList=g.getMenu(c,d)}}),a.backward=function(){f.backward()},a.forward=function(){f.forward()},a.execCMD=function(a){var b=[];"upload"==a&&(b=[h.PAGE_CONFIG.bucket.Name,h.PAGE_CONFIG.bucket.Location,h.PAGE_CONFIG.objectPrefix]),g.exec(a,b)},a.contextMenu=[]}]).controller("FileListCtrl",["$scope","$routeParams","OSSApi","buckets","$rootScope","OSSObject",function(a,b,c,d,e,f){var g=b.bucket?b.bucket:d&&d.length?d[0].Name:"",h=b.keyword||"",i="",j="/",k=!1,l=20,m="",n=!1;e.PAGE_CONFIG.bucket=Util.Array.getObjectByKeyValue(a.buckets,"Name",g),e.PAGE_CONFIG.objectPrefix=b.object?b.object:"",h.length?(i=h,k=!0):(i=e.PAGE_CONFIG.objectPrefix,k=!1),a.files=[];var o=function(){a.loadingFile||(a.loadingFile=!0,f.list(e.PAGE_CONFIG.bucket,i,j,m,l).then(function(b){a.loadingFile=!1,a.files=a.files.concat(b.files),m=b.marker,n=b.allLoaded},function(){a.loadingFile=!1}))};o(),a.openFile=function(a,b){f.open(e.PAGE_CONFIG.bucket,a.path,b)},a.loadMoreFile=function(){n||o()}}]),angular.module("ossClientUiApp").factory("OSSCmd",function(){return{upload:function(a,b,c){OSS.invoke("selectFileDlg",{path:"",disable_root:1},function(d){d&&d.list&&d.list.length&&OSS.invoke("addFile",{location:b,bucket:a,prefix:c,list:d.list},function(){})})},download:function(a){OSS.invoke("saveFile",{list:a},function(){})},create:function(){},setHttpHeader:function(){},del:function(){},getUri:function(){}}}).factory("OSSMenu",["OSSCmd",function(a){var b=[{name:"upload",text:"上传"},{name:"download",text:"下载"},{name:"create",text:"新建文件夹"},{name:"get_uri",text:"获取地址"},{name:"set_header",text:"设置HTTP头"},{name:"del",text:"删除"}];return{getDefaultMenus:function(){return angular.extend([],b)},checkPermission:function(){return!0},getMenu:function(a,b,c){var d=this.getDefaultMenus();return c&&c.length?1==c.length?this.getSelectMenu(d):(this.getMultiSelectMenu(d),this.getSelectMenu(d)):this.getCurrentMenu(d),OSS.log("getMenu",d),d},getCurrentMenu:function(a){this.disableMenu(a,"get_uri","set_header","del")},getMultiSelectMenu:function(a){this.disableMenu(a,"upload","create","get_uri","set_header")},getSelectMenu:function(a){this.disableMenu(a,"upload","download","create")},disableMenu:function(a){var b=this,c=Array.prototype.slice.call(arguments).splice(1);angular.forEach(c,function(c){var d=b.getMenuByName(a,c);console.log("menuItem",d),d&&(d.disabled=1)})},getMenuByName:function(a,b){for(var c=0;c<a.length;c++)if(a[c].name===b)return a[c];return null},exec:function(b,c){console.log("arguments",arguments),angular.isFunction(a[b])&&this.checkPermission(b)&&a[b].apply(this,c)}}}]).factory("OSSLocationHistory",["$location","$rootScope",function(a,b){var c,d=!0,e=[],f=100;return b.$on("$locationChangeSuccess",function(){var b=a.url(),g=e.length;d&&(c>=0&&g>c+1&&e.splice(c+1),e[e.length-1]!=b&&(e.push(b),e.length>f&&e.splice(0,1)),c=e.length-1),d=!0,console.log("history",e)}),{reset:function(){e=[],c=0,d=!0},go:function(b){console.log(123),(b&&this.canForward()||!b&&this.canBackward())&&(console.log(456),d=!1,a.url(e[b?++c:--c]))},forward:function(){this.go(!0)},backward:function(){this.go()},canForward:function(){return c<e.length-1},canBackward:function(){return c>0}}}]).factory("OSSObject",["$location","$filter","OSSApi","$q",function(a,b,c,d){var e={SORT_SPEC:["doc","docx","xls","xlsx","ppt","pptx","pdf","ai","cdr","psd","dmg","iso","md","ipa","apk","gknote"],SORT_MOVIE:["mp4","mkv","rm","rmvb","avi","3gp","flv","wmv","asf","mpeg","mpg","mov","ts","m4v"],SORT_MUSIC:["mp3","wma","wav","flac","ape","ogg","aac","m4a"],SORT_IMAGE:["jpg","png","jpeg","gif","psd","bmp","ai","cdr"],SORT_DOCUMENT:["doc","docx","xls","xlsx","ppt","pptx","pdf","odt","rtf","ods","csv","odp","txt","gknote"],SORT_CODE:["js","c","cpp","h","cs","vb","vbs","java","sql","ruby","php","asp","aspx","html","htm","py","jsp","pl","rb","m","css","go","xml","erl","lua","md"],SORT_ZIP:["rar","zip","7z","cab","tar","gz","iso"],SORT_EXE:["exe","bat","com"]};return{list:function(a,b,e,f,g){var h=this,i=d.defer();return c.getObjects(a,b,e,f,g).success(function(a){OSS.log("list:res",a);var c=a.ListBucketResult.Contents;c=c?angular.isArray(c)?c:c:[];var d=a.ListBucketResult.CommonPrefixes;d=d?angular.isArray(d)?d:[d]:[];var e=[];angular.forEach($.merge(c,d),function(a){a.Key!==b&&a.Prefix!==b&&e.push(h.format(a))}),i.resolve({files:e,marker:a.ListBucketResult.NextMarker,allLoaded:"false"===a.ListBucketResult.IsTruncated})}).error(function(){}),i.promise},format:function(a){var c=a.Key||a.Prefix,d="/"===Util.String.lastChar(c)?1:0,e=d?b("getPrefixName")(c,1):b("baseName")(c);return{path:c,dir:d,filename:e,lastModified:a.LastModified||"",size:a.Size||0}},open:function(b,c,d){d&&a.path("/file/"+b.Name+"/"+c)},getIconSuffix:function(a,b){var c="",d=e;if(1==a)c="folder";else{var f=Util.String.getExt(b);c=jQuery.inArray(f,d.SORT_SPEC)>-1?f:jQuery.inArray(f,d.SORT_MOVIE)>-1?"movie":jQuery.inArray(f,d.SORT_MUSIC)>-1?"music":jQuery.inArray(f,d.SORT_IMAGE)>-1?"image":jQuery.inArray(f,d.SORT_DOCUMENT)>-1?"document":jQuery.inArray(f,d.SORT_ZIP)>-1?"compress":jQuery.inArray(f,d.SORT_EXE)>-1?"execute":"other"}return c},getIcon:function(a,b){return"icon-"+this.getIconSuffix(a,b)}}}]).factory("OSSLocation",function(){return{getUrl:function(a,b){return b=angular.isUndefined(b)?"":b,["/file/",a,"/",b].join("")}}}).factory("Bread",["OSSLocation",function(a){return{getBreads:function(b,c){var d=[{name:b,url:a.getUrl(b)}];if(c&&c.length){c=Util.String.rtrim(Util.String.ltrim(c,"/"),"/");for(var e=c.split("/"),f=0;f<e.length;f++){for(var g={name:e[f]},h="",i=0;f>=i;i++)h+=e[i]+"/";g.url=a.getUrl(b,h),d.push(g)}}return d}}}]).factory("RequestXML",function(){return{getXMLHeader:function(){return'<?xml version="1.0" encoding="UTF-8"?>'},getCreateBucketXML:function(a){return[this.getXMLHeader(),"<CreateBucketConfiguration >","<LocationConstraint >",a,"</LocationConstraint >","</CreateBucketConfiguration >"].join("")}}}).factory("Bucket",["OSSApi","$q",function(a,b){var c=null,d=b.defer();return{list:function(){return c?d.resolve(d):a.getBuckets().success(function(a){c=a.ListAllMyBucketsResult.Buckets.Bucket,d.resolve(angular.isArray(c)?c:[c])}).error(function(){d.reject()}),d.promise},getRegions:function(){return{"oss-cn-hangzhou-a":"杭州","oss-cn-qingdao-a":"青岛","oss-cn-beijing-a":"北京","oss-cn-hongkong-a":"香港","oss-cn-shenzhen-a":"深圳"}},getAcls:function(){return{"public-read-write":"公共读写","public-read":"公共读","private":"私有"}}}}]).factory("OSSApi",["$http","RequestXML",function(a,b){var c=OSS.invoke("getAccessID"),d=function(a,b,c,d){d=angular.isUndefined(d)?!1:d,b=angular.isUndefined(b)?"":b,c=angular.isUndefined(c)?"":c;var e=d?"https:":["https:","http:"].indexOf(location.protocol)>=0?location.protocol:"http:";return e+"//"+(a?a+".":"")+(b?b+".":"")+"aliyuncs.com"+c},e=function(a){return a=angular.isUndefined(a)?60:a,parseInt((new Date).getTime()/1e3)+a},f=function(a,b,d,e){return a+"?"+(e?e+"&":"")+$.param({OSSAccessKeyId:c,Expires:b,Signature:d})};return{getBuckets:function(){var b=e(),c=d("oss","","/");OSS.log("host",c);var g=OSS.invoke("getSignature",{verb:"GET",content_md5:"",content_type:"",expires:b,canonicalized_oss_headers:"",canonicalized_resource:"/"}),h=f(c,b,g);return a.get(h)},createBucket:function(c,g,h){OSS.log("createBucket",arguments);var i=e(),j=d(c,g),k={"x-oss-acl":h},l="application/xml",m=OSS.invoke("getSignature",{verb:"PUT",content_md5:"",content_type:l,expires:i,canonicalized_oss_headers:k,canonicalized_resource:"/"+c+"/"}),n=f(j,i,m),o=angular.extend({},k,{"Content-Type":l});return a.put(n,b.getCreateBucketXML(g),{headers:o})},getBucketAcl:function(b){var c=e(),g=d(b.Name,b.Location),h="",i="",j=OSS.invoke("getSignature",{verb:"GET",content_md5:"",content_type:i,expires:c,canonicalized_oss_headers:h,canonicalized_resource:"/"+b.Name+"/?acl"}),k=f(g,c,j,"acl"),l=angular.extend({},h,{"Content-Type":i});return a.get(k,"",{headers:l})},editBucket:function(b,c){var g=e(),h=d(b.Name,b.Location),i={"x-oss-acl":c},j="application/xml",k=OSS.invoke("getSignature",{verb:"PUT",content_md5:"",content_type:j,expires:g,canonicalized_oss_headers:i,canonicalized_resource:"/"+b.Name+"/"}),l=f(h,g,k),m=angular.extend({},i,{"Content-Type":j});return a.put(l,"",{headers:m})},delBucket:function(b){var c=e(),g=d(b.Name,b.Location),h="",i="",j=OSS.invoke("getSignature",{verb:"DELETE",content_md5:"",content_type:i,expires:c,canonicalized_oss_headers:h,canonicalized_resource:"/"+b.Name+"/"}),k=f(g,c,j),l=angular.extend({},h);return a.delete(k,"",{headers:l})},getObjects:function(b,c,g,h,i){var j={prefix:c};$.extend(j,{delimiter:g,marker:h,"max-keys":i}),console.log("param",j);var k=$.param(j,!0);console.log("queryStr",k);var l=e(),m=d(b.Name,b.Location),n="",o=OSS.invoke("getSignature",{verb:"GET",content_md5:"",expires:l,canonicalized_oss_headers:n,canonicalized_resource:"/"+b.Name+"/"}),p=f(m,l,o,k),q=angular.extend({},n);return a.get(p,{headers:q})}}}]).factory("OSSModal",["$modal","Bucket","OSSApi",function(a,b,c){var d={backdrop:"static"};return{addBucket:function(e){var f={templateUrl:"views/add_bucket_modal.html",windowClass:"add_bucket_modal",controller:function(a,d){a.loading=!1,a.bucket=e;var f=[],g=[];angular.forEach(b.getAcls(),function(a,b){f.push({name:a,value:b})}),a.acls=f,e||(a.acl=a.acls[0]),angular.forEach(b.getRegions(),function(a,b){g.push({name:a,value:b})}),a.regions=g,a.region=e?Util.Array.getObjectByKeyValue(a.regions,"value",e.Location):a.regions[0],a.bucket?(a.loading=!0,c.getBucketAcl(e).success(function(b){a.loading=!1,a.acl=Util.Array.getObjectByKeyValue(a.acls,"value",b.AccessControlPolicy.AccessControlList.Grant)})):a.loading=!0,a.cancel=function(){d.dismiss("cancel")},a.createBucket=function(a,b,e){c.createBucket(a,b.value,e.value).success(function(){d.close({act:"add",bucket:{Name:a,Location:b.value,Acl:e.value}})})},a.editBucket=function(a){c.editBucket(e,a.value).success(function(){angular.extend(e,{Acl:a.value}),d.close({act:"edit",bucket:e})})},a.delBucket=function(){c.delBucket(e).success(function(){d.close({act:"del",bucket:e})})}}};return f=angular.extend({},d,f),a.open(f)}}}]),angular.module("ossClientUiApp").filter("bitSize",function(){return Util.Number.bitSize}).filter("formatTime",["$filter",function(a){return function(b){return a("date")(Date.parse(b),"yyyy-MM-dd HH:mm:ss")}}]).filter("getPrefixName",function(){return function(a,b){b=angular.isUndefined(b)?0:b;var c=a.split("/");return c[c.length-2]+(b?"":"/")}}).filter("baseName",function(){return Util.String.baseName}),angular.module("ossClientUiApp").directive("smartSearch",["$location","$rootScope","$filter",function(a,b,c){return{restrict:"A",require:"ngModel",link:function(d,e,f,g){var h=e.parent().next();e.on("keydown",function(b){var c=b.keyCode;13==c&&(console.log("ngModel.$modelValue",g.$modelValue),d.$apply(function(){a.search({keyword:g.$modelValue,scope:""})}))});var i=h.find(".bread-list"),j=e.parent(),k=function(){if(!e.next(".search-scope").size()){var a=b.PAGE_CONFIG.objectPrefix?c("getPrefixName")(b.PAGE_CONFIG.objectPrefix,1):b.PAGE_CONFIG.bucket.Name,d=$('<a href="javascript:;" class="fa fa-remove fa-lg"></a>'),f=$('<div class="search-scope"> 在 <span>'+a+"</span> 中搜索</div>");e.next(".fa").hide(),e.after(f).after(d),e.css({"padding-left":f.outerWidth(!0)+6}),i.hide(),d.on("click",function(){l()}),e.focus()}},l=function(){j.find(".search-scope").remove(),j.find(".fa-remove").remove(),i.show(),e.next(".fa").show()};e.on("mousedown",function(){k()}),e.next(".fa").on("click",function(){k()})}}}]).directive("fileIcon",["OSSObject",function(a){return{template:'<i class="file-icon-{{size}} {{icon}}"></i>',restrict:"E",replace:!0,scope:{dir:"@",filename:"@",size:"@"},link:function(b){b.icon=a.getIcon(b.dir,b.filename)}}}]);